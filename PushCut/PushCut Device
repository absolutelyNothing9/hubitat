/**
 * Pushcut Mobile Device Driver
 * Represents a SINGLE iPhone/iPad (or 'All').
 */

import groovy.json.JsonSlurper

metadata {
    definition (name: "Pushcut Mobile Device", namespace: "absolutelyNothing9", author: "absolutelyNothing9") {
        capability "Notification" 
        capability "Actuator"
        
        // Custom Command: Full Pushcut Notification API Support
        command "sendPushcutNotification", [
            [name:"Notification Name*", type: "STRING", description: "Name defined in Pushcut App"],
            [name:"Title", type: "STRING"],
            [name:"Text", type: "STRING"],
            [name:"Sound", type: "STRING"],
            [name:"Image URL", type: "STRING"],
            [name:"Is Time Sensitive", type: "ENUM", constraints: ["false", "true"]],
            [name:"Delay", type: "STRING", description: "e.g., '10m', '5s'"],
            [name:"Scheduled Timestamp", type: "STRING", description: "ISO 8601 Date"],
            [name:"Notification ID", type: "STRING", description: "Unique ID for replacing updates"],
            [name:"Thread ID", type: "STRING", description: "For grouping in Notification Center"],
            [name:"Default Action (JSON)", type: "STRING", description: "{ \"action\": \"url\", \"url\": \"...\" }"],
            [name:"Actions Array (JSON)", type: "STRING", description: "[ { \"name\": \"Action1\", ... } ]"]
        ]

        // Custom Command: Update Widget
        command "updateWidget", [
            [name:"Widget Name*", type: "STRING"],
            [name:"Content JSON", type: "STRING", description: "Visuals: {\"text\": \"Hi\"}"],
            [name:"Inputs JSON", type: "STRING", description: "Logic: {\"var\": 1}"],
            [name:"OnTap Action", type: "ENUM", constraints: ["none", "url", "shortcut", "homekit", "webhook"]],
            [name:"OnTap Value", type: "STRING", description: "URL, Shortcut Name, or Scene Name"],
            [name:"OnTap Input", type: "STRING", description: "Input passed to Shortcut/Webhook"],
            [name:"Run On Server", type: "ENUM", constraints: ["false", "true"]]
        ]
        
        attribute "lastStatus", "string"
    }
}

// Simple Hubitat Notification (Backward compatibility)
def deviceNotification(text) {
    // defaults to empty for optional fields
    sendPushcutNotification("Hubitat", "Hubitat Alert", text, null, null, "false", null, null, null, null, null, null)
}

// ------------------------------------------------------------------
// NOTIFICATION LOGIC (Strict API Spec)
// ------------------------------------------------------------------

def sendPushcutNotification(notifName, title, text, sound, image, isTimeSensitive, delay, scheduledTimestamp, notifId, threadId, defaultActionJson, actionsJson) {
    def targetDevice = getDataValue("pushcutTarget")
    def payload = [:]

    // --- 1. Basic Content ---
    if (title) payload.title = title
    if (text) payload.text = text
    if (sound) payload.sound = sound
    if (image) payload.image = image

    // --- 2. Root Options ---
    if (isTimeSensitive == "true") payload.isTimeSensitive = true
    if (delay) payload.delay = delay
    if (scheduledTimestamp) payload.scheduledTimestamp = scheduledTimestamp
    if (notifId) payload.id = notifId
    if (threadId) payload.threadId = threadId

    // --- 3. Default Action Object ---
    // Allowed keys: name, input, keepNotification, shortcut, homekit, runOnServer, online, url, urlBackgroundOptions
    if (defaultActionJson) {
        try {
            def parsed = new JsonSlurper().parseText(defaultActionJson)
            if (parsed instanceof Map) {
                payload.defaultAction = parsed
            } else {
                log.warn "Pushcut: Default Action JSON must be a valid Object {}. Received: ${parsed}"
            }
        } catch (e) { log.error "Pushcut: Invalid Default Action JSON: ${e}" }
    }

    // --- 4. Actions Array ---
    // Allowed keys in objects: name, input, keepNotification, shortcut, homekit, runOnServer, online, url, urlBackgroundOptions
    if (actionsJson) {
        try {
            def parsed = new JsonSlurper().parseText(actionsJson)
            if (parsed instanceof List) {
                payload.actions = parsed
            } else {
                log.warn "Pushcut: Actions JSON must be a List []. Received: ${parsed}"
            }
        } catch (e) { log.error "Pushcut: Invalid Actions JSON: ${e}" }
    }

    log.info "Pushcut [${device.label}]: Sending Notification '${notifName}'"
    parent.sendPushcutPayload("notifications/${notifName}", targetDevice, payload)
    sendEvent(name: "lastStatus", value: "Notif Sent: ${new Date().format('HH:mm:ss')}")
}

// ------------------------------------------------------------------
// WIDGET LOGIC
// ------------------------------------------------------------------

def updateWidget(widgetName, contentJson, inputsJson, actionType, actionValue, actionInput, runOnServer) {
    def targetDevice = getDataValue("pushcutTarget")
    def payload = [:]

    // 1. Content & Inputs
    try { if (contentJson) payload.content = new JsonSlurper().parseText(contentJson) } catch (e) {}
    try { if (inputsJson) payload.inputs = new JsonSlurper().parseText(inputsJson) } catch (e) {}

    // 2. On Tap Logic
    def onTapMap = [:]
    if (actionType && actionType != "none") {
        onTapMap.action = actionType
        
        if (actionType == "url") onTapMap.url = actionValue
        else if (actionType == "shortcut") {
            onTapMap.shortcut = actionValue
            if (actionInput) onTapMap.input = actionInput
        } 
        else if (actionType == "homekit") onTapMap.scene = actionValue
        else if (actionType == "webhook") {
            onTapMap.name = actionValue
            if (actionInput) onTapMap.input = actionInput
        }
        
        if (runOnServer == "true") onTapMap.shouldRunOnServer = true
    }
    
    if (onTapMap) payload.onTap = onTapMap

    log.info "Pushcut [${device.label}]: Updating Widget '${widgetName}'"
    parent.sendPushcutPayload("widgets/${widgetName}", targetDevice, payload)
    sendEvent(name: "lastStatus", value: "Widget Updated: ${new Date().format('HH:mm:ss')}")
}
