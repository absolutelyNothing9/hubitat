/*
 *  Licensed under the Apache License, Version 2.0 (the "License"); you may not
 *  use this file except in compliance with the License. You may obtain a copy
 *  of the License at:
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 *  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 *  License for the specific language governing permissions and limitations
 *  under the License.
 */

import groovy.json.JsonSlurper


preferences {
        input "token", "text", title: "Token", required: true
        input "device_key", "string", title: "Device Key", required: true
        input "name", "text", title: "Device Name", required: true
		}

metadata {
	definition (name: "Nightingale", namespace: "absolutelyNothing", author: "absolutelyNothing") {
        capability "Switch"
        capability "Battery"
        capability "Refresh"
        capability "Switch Level"


        command "Crickets"
        command "Loons"
        command "Rain"
        command "Lakeshore"
        command "Whales"
        command "Toggle Sound Mode"
        command "refreshDevices"
        command "getGroup"
        command "getGroups"
        command "createGroup"
        command "renameGroup"
        command "deleteGroup"
        command "addToGroup"
	command "groupFunctions", [[name:"Relax Sound", type:"ENUM", description:"Select Nature Sound", constraints:["getGroup","getGroups","addToGroup","createGroup","renameGroup","deleteGroup"]]] 
        command "setLightColor", [[name:"Light Color", type: "ENUM", constraints: ["Blue","Green","Red","Purple","Yellow"] ] ]
        command "setLightLevel", [[name:"Light Level", type: "ENUM", constraints: ["1","2","3","4","5","6","7","8","9","10"] ] ]
        command "setLightSwitch", [[name:"Light Switch", type: "ENUM", constraints: ["On","Off"] ] ]
        command "setPower", [[name:"Power On/Off", type: "ENUM", constraints: ["On","Off"] ] ]
        command "setSoundMode", [[name:"Sound Mode", type: "ENUM", constraints: ["Relax","Sleep"] ] ]
        command "setVolume", [[name:"Volume", type: "ENUM", constraints: ["1","2","3","4","5","6","7","8","9","10"] ] ]
        command "setNeutralSleepSound", [[name:"Neutral Sleep Sound", type: "ENUM", constraints: ["General Bedroom","Kids Room","Snoring","Tinnitus","Hospital Room"] ] ]
        command "setReflectiveSleepSound", [[name:"Reflective Sleep Sound", type: "ENUM", constraints: ["General Bedroom","Kids Room","Snoring","Tinnitus","Hospital Room"] ] ]
        command "setAbsorptiveSleepSound", [[name:"Absorptive Sleep Sound", type: "ENUM", constraints: ["General Bedroom","Kids Room","Snoring","Tinnitus","Hospital Room"] ] ]
	command "setRelaxSound", [[name:"Relax Sound", type:"ENUM", description:"Select Nature Sound", constraints:["Crickets","Lakeshore","Loons","Rain","Whales"]]]


        
        

	
        
        //attribute "SoundStatus", "string"     
        attribute "SoundMute", "string"
        //attribute "SleepVolume", "integer"
        attribute "SleepSound", "string"
        attribute "PageVolume", "integer"
        attribute "Balance", "integer"
        attribute "SoundMode", "string"
        attribute "RelaxSound", "string"
        //attribute "RelaxVolume", "integer"
        attribute "LightStatus", "string"
        attribute "LightLevel", "integer"
        attribute "LightColor", "string"
        attribute "SoundScheduled", "integer"
        //attribute "LightScheduled", "integer"
        //attribute "SoundOn", "string"
        //attribute "SoundOff", "string"
        //attribute "LightOn", "string"
        //attribute "LightOff", "string"
        attribute "Ramp", "integer"
        attribute "DisableButton", "integer"
        attribute "RoomName", "string"
        attribute "Dwelling", "string"  
        attribute "Volume", "integer"

	}

}


def allPurposeFlour(response, data) {
        log.debug "status of post call is: ${response.status}"
        log.info "${response.data}"

}
def getDevice(response, data) {
      log.debug "status of post call is: ${response.status}"
        log.info "${response.data}"
        Map deviceProperties = new 
            groovy.json.JsonSlurper().parseText(response.json.getAt(3).property.value)
    


    def soundStatus = "${deviceProperties.soundStatus == 0 ? "Off" : reportValue == 1 ? "On": "error"}"
        sendEvent(name: "SoundStatus", value: soundStatus)
    
    def soundMute = "${deviceProperties.soundMute}"
        sendEvent(name: "SoundMute", value: soundMute)
    
    def sleepVolume = "${deviceProperties.sleepVolume}"
        sendEvent(name: "SleepVolume", value: sleepVolume)
    
    def sleepSound = "${deviceProperties.sleepSound == 210 ? "General Room (Neutral)" : reportValue == 215 ? "Kids Room (Neutral)" : reportValue == 220 ? "Snoring Blanket (Neutral)" : reportValue == 225 ? "Tinnitus (Neutral)" : reportValue == 230 ? "Hospital Room (Neutral)" : reportValue == 310 ? "General Room (Reflective)": reportValue == 315 ? "Kids Room (Reflective)": reportValue == 320 ? "Snoring (Reflective)" : reportValue == 325 ? "Tinnitus (Reflective)" : reportValue == 330 ? "Hospital Room (Reflective)" : reportValue == 410 ? "General Room (Absorptive)": reportValue == 415 ? "Kids Room (Absorptive)": reportValue == 420 ? "Snoring (Absorptive)" : reportValue == 425 ? "Tinnitus (Absorptive)": reportValue == 430 ? "Hospital Room ((Absorptive)" : "error"}"
        sendEvent(name: "SleepSound", value: sleepSound)
    
    def pageVol = "${deviceProperties.pageVol}"
        sendEvent(name: "PageVolume", value: pageVol)
   
    def balance = "${deviceProperties.balance}"
        sendEvent(name: "Balance", value: balance)
    
    def soundMode = "${deviceProperties.soundMode == 0 ? "Sleep" : reportValue == 1 ? "Relax": "error"}"
        sendEvent(name: "SoundMode", value: soundMode)
    
    def relaxSound = "${deviceProperties.relaxSound == 510 ? "Lakeshore" : reportValue == 520 ? "Crickets" : reportValue == 530 ? "Loons" : reportValue == 540 ? "Whales" : reportValue == 550 ? "Rain" : "error"}"
        sendEvent(name: "RelaxSound", value: relaxSound)
    
    def relaxVolume = "${deviceProperties.relaxVolume}"
        sendEvent(name: "relaxVolume", value: relaxVolume)
    
    def lightStatus = "${deviceProperties.lightStatus == 0 ? "Off" : reportValue == 1 ? "On": "error"}"
        sendEvent(name: "LightStatus", value: lightStatus)
    
    def lightLevel = "${deviceProperties.lightLevel}"
        sendEvent(name: "LightLevel", value: lightLevel)
    
    def lightColor = "${deviceProperties.lightColor}"
        sendEvent(name: "LightColor", value: lightColor)
    
    def soundScheduled = "${deviceProperties.soundScheduled}"
        sendEvent(name: "SoundScheduled", value: soundScheduled)
    
    //def lightScheduled = "${deviceProperties.lightScheduled}"
       // sendEvent(name: "LightScheduled", value: lightScheduled)
    
    def soundOn = "${deviceProperties.soundOn}"
        sendEvent(name: "SoundOn", value: soundOn)
    
    def soundOff = "${deviceProperties.soundOff}"
        sendEvent(name: "SoundOff", value: soundOff)
    
    //def lightOn = "${deviceProperties.lightOn}"
        //sendEvent(name: "LightOn", value: lightOn)
    
    //def lightOff = "${deviceProperties.soundOff}"
        //sendEvent(name: "LightOff", value: lightOff)
        
    def ramp = "${deviceProperties.ramp}"
        sendEvent(name: "Ramp", value: ramp)

    def disableBtn = "${deviceProperties.disableBtn}"
        sendEvent(name: "DisableButton", value: disableBtn)
    
    def roomName = "${deviceProperties.roomName}"
        sendEvent(name: "RoomName", value: roomName)
        
    def dwelling = "${deviceProperties.dwelling}"
        sendEvent(name: "Dwelling", value: dwelling)

 }

def volume8() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/289261179/datapoints.json",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": "{\\"relaxVolume\\":\\"8\\",\\"sleepVolume\\":\\"8\\"}"}}'
                  ]
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "RelaxSound", value: "Lakeshore")
}


def Lakeshore() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/289261179/datapoints.json",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": "{\\"relaxSound\\":\\"510\\"}"}}'
                  ]
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "RelaxSound", value: "Lakeshore")
}
def Crickets() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/289261179/datapoints.json",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": "{\\"relaxSound\\":\\"520\\"}"}}'
                  ]
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "RelaxSound", value: "Crickets")
}
def Loons() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/289261179/datapoints.json",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": "{\\"relaxSound\\":\\"530\\"}"}}'
                  ]
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "RelaxSound", value: "Loons")
}
def Whales() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/289261179/datapoints.json",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": "{\\"relaxSound\\":\\"540\\"}"}}'
                  ]
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "RelaxSound", value: "Whales")
}
def Rain() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/289261179/datapoints.json",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": "{\\"relaxSound\\":\\"550\\"}"}}'
                  ]
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "RelaxSound", value: "Rain")
}


def getAccessTokens() {

    def postParams = [
        uri: "https://user-field.aylanetworks.com/users/sign_in",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            body: '{"user": {"email": "andyjarmijo@gmail.com","password": "Diseased1!","application" :{"app_id": "ng-ios-id","app_secret": "ng-ios-4jbbS9drkYCdk3x4uviG9Mduhrs"}}'
           
                  ]
    
    asynchttpPost('signIn', postParams, [dataitem1: "datavalue1"])
}

def refresh() {

    def postParams = [
        uri: "https://user-field.aylanetworks.com/users/sign_in",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            body: '{"user": {"email": "andyjarmijo@gmail.com","password": "Diseased1!","application" :{"app_id": "ng-ios-id","app_secret": "ng-ios-4jbbS9drkYCdk3x4uviG9Mduhrs"}}'
           
                  ]
    
    asynchttpPost('signIn', postParams, [dataitem1: "datavalue1"])
    
//schedule the rescheduler to schedule refresh ;)
  if ((state.polling?.rescheduler?:0) + 86400 < now()) {
    log.info "Scheduling Auto Rescheduler.."
    runEvery30Minutes(runRefresh)    
    state.polling?.rescheduler = now()
  }
}
// Schedule refresh
def runRefresh(evt) {
  log.info "Last refresh was "  + ((now() - state.polling?.last?:0)/60000) + " minutes ago"
  // Reschedule if  didn't update for more than 5 minutes plus specified polling
  if ((((state.polling?.last?:0) + (((settings.polling?.toInteger()?:1>0)?:1) * 60000) + 300000) < now()) && canSchedule()) {
    log.info "Scheduling Auto Refresh.."
    schedule("* */" + ((settings.polling?.toInteger()?:1>0)?:1) + " * * * ?", refresh)
  }
    
  // Force Refresh NOWWW!!!!
  refresh()
    
  //Update rescheduler's last run
  if (!evt) state.polling?.rescheduler = now()
}
def signIn(response, data) {
        if(response.status == 200)
            {
                jsonMap = response.data
                if (response.data) {
                    state.refreshToken = response.json.refresh_token
                    state.accessToken = response.json.access_token
                    state.session = now() + 86400
            }
                

        log.info "Acess Token being ${state.accessToken}"
        log.info "Refresh Token being ${state.refreshToken}"
        log.info "Expiration being ${state.session}"
    
}
}
def refreshDevices() {

    def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/devices",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"]

           
                  ]
    
    asynchttpGet('getDevices', postParams, [Authorization: "Bearer ${state.accessToken}"])
}
def getDevices(response, data) {
        log.debug "status of post call is: ${response.status}"
        log.info "${response.data}"

}
def off() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/289261179/datapoints.json",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": "{\\"soundStatus\\":\\"0\\"}"}}'
                  ]
    
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "switch", value: "off")


}          
def on() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/289261179/datapoints.json",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Nightingale/1.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": "{\\"soundStatus\\":\\"1\\"}"}}'
                  ]
    
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "switch", value: "on")


}
