
definition(
    name: "Nightingale Integration",
    namespace: "absolutelyNothing9",
    author: "absolutelyNothing9",
    description: "Integrates Nightingale sound blankets via Ayla Networks.",
    category: "My Apps"
)

preferences {
    page(name: "mainPage")
    page(name: "authPage")
}

def mainPage() {
    return dynamicPage(name: "mainPage", title: "Nightingale Config", install: true, uninstall: true) {
        section("Credentials") {
            input "username", "text", title: "Email", required: true
            input "password", "password", title: "Password", required: true
        }
        section {
            href(name: "authLink", title: "Authorize & Discover", page: "authPage")
        }
    }
}

def authPage() {
    login()
    def devices = discoverDevices()
    return dynamicPage(name: "authPage", title: "Discovery") {
        section("Devices Found") {
            if (devices) {
                devices.each { paragraph "Found: ${it.device.product_name}" }
            } else { paragraph "No Nightingale devices found." }
        }
    }
}

def login() {
    def params = [
        uri: "https://ads-field.aylanetworks.com/users/sign_in.json",
        body: [user: [email: settings.username, password: settings.password, 
               application: [app_id: "Nightingale-6348421-id", app_secret: "Nightingale-6348421-secret-M_V_1"]]]
    ]
    try {
        httpPostJson(params) { resp -> state.accessToken = resp.data.access_token }
    } catch (e) { log.error "Nightingale Login Failed: ${e}" }
}

def discoverDevices() {
    def params = [
        uri: "https://ads-field.aylanetworks.com/apiv1/devices.json",
        headers: ["Authorization": "auth_token ${state.accessToken}"]
    ]
    try {
        httpGet(params) { resp ->
            resp.data.each { item ->
                def d = item.device
                def dni = "Night-${d.dsn}"
                if (!getChildDevice(dni)) {
                    // LOGIC: Check if it is a group or a single unit
                    def driverName = (d.product_name?.toLowerCase()?.contains("group")) ? "Nightingale Group" : "Nightingale"
                    
                    addChildDevice("absolutelyNothing9", driverName, dni, [
                        label: "Nightingale: ${d.product_name}", 
                        data: [dsn: d.dsn, isGroup: (driverName == "Nightingale Group")]
                    ])
                }
            }
            return resp.data
        }
    } catch (e) { log.error "Discovery error: ${e}" }
}
/**
 * Refreshes all properties for a specific Nightingale device
 * This allows Hubitat to see volume, sound, and color changes made outside of Hubitat.
 */
def refreshChildData(dsn) {
    if (!state.accessToken) return
    
    log.debug "Refreshing Nightingale data for DSN: ${dsn}"
    def url = "https://ads-field.aylanetworks.com/apiv1/devices/${dsn}/properties.json"
    
    def params = [
        uri: url,
        headers: ["Authorization": "auth_token ${state.accessToken}", "Content-Type": "application/json"]
    ]
    
    try {
        httpGet(params) { resp ->
            if (resp.status == 200) {
                def child = getChildDevice("Night-${dsn}")
                resp.data.each { propWrapper ->
                    def p = propWrapper.property
                    
                    // Nightingale specific: the 'cmd' property contains a JSON string
                    if (p.name == "cmd" && child) {
                        parseNightingaleJson(child, p.value)
                    } else if (child) {
                        // Standard properties like battery or online status
                        child.generateEvent([name: p.name, value: p.value])
                    }
                }
            }
        }
    } catch (e) {
        log.error "Failed to refresh Nightingale data: ${e}"
    }
}

/**
 * Parses the nested JSON inside Nightingale's 'cmd' property
 */
def parseNightingaleJson(child, jsonString) {
    try {
        def slurper = new groovy.json.JsonSlurper()
        def data = slurper.parseText(jsonString)
        
        // Map Ayla JSON keys to Hubitat Attribute names
        if (data.soundStatus != null) child.generateEvent([name: "switch", value: data.soundStatus == "1" ? "on" : "off"])
        if (data.relaxVolume != null) child.generateEvent([name: "volume", value: data.relaxVolume])
        if (data.relaxSound != null)  child.generateEvent([name: "relaxSound", value: data.relaxSound])
        if (data.lightColor != null)  child.generateEvent([name: "lightColor", value: data.lightColor])
        if (data.lightStatus != null) child.generateEvent([name: "lightStatus", value: data.lightStatus == "1" ? "on" : "off"])
    } catch (e) {
        log.error "Error parsing Nightingale JSON: ${e}"
    }
}
// Helper for Child Drivers
def sendAylaCommand(dsn, prop, val) {
    def params = [
        uri: "https://ads-field.aylanetworks.com/apiv1/properties/${dsn}/datapoints.json",
        headers: ["Authorization": "auth_token ${state.accessToken}"],
        body: [datapoint: [value: val]]
    ]
    httpPostJson(params) { log.debug "Command successful" }
}
