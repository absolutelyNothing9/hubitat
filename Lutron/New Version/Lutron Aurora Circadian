/**
 * Lutron Aurora Dimmer - Full 6-Schedule Circadian Engine
 * Features: Push-to-Sync, 6-Point Schedule with Level & Color Defaults
 */

metadata {
    definition (name: "Lutron Aurora Dimmer - Full Restored", namespace: "absolutelyNothing", author: "absolutelyNothing") {
        capability "Actuator"
        capability "Switch"
        capability "Switch Level"
        capability "Color Temperature"
        capability "Battery"
        capability "Refresh"
        capability "PushableButton"
        capability "Presence Sensor"

        attribute "scene", "string"
        attribute "presence", "string"

        fingerprint profileId: "0104", inClusters: "0000,0001,0003,1000,FC00", outClusters: "0003,0004,0006,0008,0019,1000", manufacturer: "Lutron", model: "Z3-1BRL"
    }

    preferences {
        input(name: "silentTimeAfterPush", type: "number", title: "Ignore rotation after push (ms)", defaultValue: 400)
        
        // RESTORED 6-SCHEDULE CONFIGURATION WITH TITLES AND DEFAULTS
        section("Schedule 1: Early Dawn") {
            input "schedule1scene", "string", title: "Schedule 1 Scene", defaultValue: "Sunrise"
            input "schedule1start", "string", title: "Schedule 1 Start (Sunrise Offset)", defaultValue: "-0:30"
            input "schedule1colorTemp", "int", title: "Schedule 1 Color Temp", defaultValue: 2237, unit: "K"
            input "schedule1level", "int", title: "Schedule 1 Level", defaultValue: 20
        }
        section("Schedule 2: Sunrise") {
            input "schedule2scene", "string", title: "Schedule 2 Scene", defaultValue: "Energize"
            input "schedule2start", "string", title: "Schedule 2 Start (Sunrise Offset)", defaultValue: "0:00"
            input "schedule2colorTemp", "int", title: "Schedule 2 Color Temp", defaultValue: 2890, unit: "K"
            input "schedule2level", "int", title: "Schedule 2 Level", defaultValue: 50
        }
        section("Schedule 3: Morning") {
            input "schedule3scene", "string", title: "Schedule 3 Scene", defaultValue: "Concentrate"
            input "schedule3start", "string", title: "Schedule 3 Start (Sunrise Offset)", defaultValue: "1:30"
            input "schedule3colorTemp", "int", title: "Schedule 3 Color Temp", defaultValue: 4291, unit: "K"
            input "schedule3level", "int", title: "Schedule 3 Level", defaultValue: 100
        }
        section("Schedule 4: Midday") {
            input "schedule4scene", "string", title: "Schedule 4 Scene", defaultValue: "Full Daylight"
            input "schedule4start", "string", title: "Schedule 4 Start (Sunrise Offset)", defaultValue: "4:30"
            input "schedule4colorTemp", "int", title: "Schedule 4 Color Temp", defaultValue: 6410, unit: "K"
            input "schedule4level", "int", title: "Schedule 4 Level", defaultValue: 100
        }
        section("Schedule 5: Sunset") {
            input "schedule5scene", "string", title: "Schedule 5 Scene", defaultValue: "Sunset"
            input "schedule5start", "string", title: "Schedule 5 Start (Sunset Offset)", defaultValue: "0:00"
            input "schedule5colorTemp", "int", title: "Schedule 5 Color Temp", defaultValue: 2890, unit: "K"
            input "schedule5level", "int", title: "Schedule 5 Level", defaultValue: 60
        }
        section("Schedule 6: Late Night") {
            input "schedule6scene", "string", title: "Schedule 6 Scene", defaultValue: "Nightlight"
            input "schedule6start", "string", title: "Schedule 6 Start (Sunset Offset)", defaultValue: "3:00"
            input "schedule6colorTemp", "int", title: "Schedule 6 Color Temp", defaultValue: 2237, unit: "K"
            input "schedule6level", "int", title: "Schedule 6 Level", defaultValue: 10
        }
    }
}

def parse(String description) {
    def event = zigbee.getEvent(description)
    if (event) {
        if (event.name == "battery") sendEvent(name: "battery", value: event.value, unit: "%")
    } else {
        def descMap = zigbee.parseDescriptionAsMap(description)
        if (descMap?.clusterInt == 0x0008) handleRotation(descMap)
        else if (descMap?.clusterInt == 0x0006) handleButton()
    }
}

def handleRotation(descMap) {
    state.lastMove = now()
    if (state.lastMove - (state.lastPush ?: 0) < (silentTimeAfterPush ?: 400)) return

    int rawValue = Integer.parseInt(descMap.data[0], 16)
    int level = Math.round(rawValue * (100/254))
    
    state.level = level
    syncCircadian(false) 
    
    sendEvent(name: "level", value: level, type: "physical")
    sendEvent(name: "switch", value: (level > 0 ? "on" : "off"), type: "physical")
}

def handleButton() {
    state.lastPush = now()
    if (device.currentValue("switch") == "on") {
        sendEvent(name: "switch", value: "off", type: "digital")
    } else {
        syncCircadian(true) 
        sendEvent(name: "switch", value: "on", type: "digital")
    }
}

def syncCircadian(forceLevel = false) {
    def now = new Date()
    def times = [
        s1: getSunriseAndSunset(sunriseOffset: schedule1start).sunrise,
        s2: getSunriseAndSunset(sunriseOffset: schedule2start).sunrise,
        s3: getSunriseAndSunset(sunriseOffset: schedule3start).sunrise,
        s4: getSunriseAndSunset(sunriseOffset: schedule4start).sunrise,
        s5: getSunriseAndSunset(sunsetOffset: schedule5start).sunset,
        s6: getSunriseAndSunset(sunsetOffset: schedule6start).sunset
    ]
    
    // Default to Schedule 6 (Late Night) if outside all windows
    def targetTemp = schedule6colorTemp
    def targetLvl = schedule6level
    def sceneName = schedule6scene

    if (timeOfDayIsBetween(times.s1, times.s2, now, location.timeZone)) {
        targetTemp = schedule1colorTemp; targetLvl = schedule1level; sceneName = schedule1scene
    } else if (timeOfDayIsBetween(times.s2, times.s3, now, location.timeZone)) {
        targetTemp = schedule2colorTemp; targetLvl = schedule2level; sceneName = schedule2scene
    } else if (timeOfDayIsBetween(times.s3, times.s4, now, location.timeZone)) {
        targetTemp = schedule3colorTemp; targetLvl = schedule3level; sceneName = schedule3scene
    } else if (timeOfDayIsBetween(times.s4, times.s5, now, location.timeZone)) {
        targetTemp = schedule4colorTemp; targetLvl = schedule4level; sceneName = schedule4scene
    } else if (timeOfDayIsBetween(times.s5, times.s6, now, location.timeZone)) {
        targetTemp = schedule5colorTemp; targetLvl = schedule5level; sceneName = schedule5scene
    }

    sendEvent(name: "colorTemperature", value: targetTemp, unit: "K")
    sendEvent(name: "scene", value: sceneName)
    
    if (forceLevel) {
        sendEvent(name: "level", value: targetLvl, unit: "%")
    }
}

def on() { syncCircadian(true); sendEvent(name: "switch", value: "on") }
def off() { sendEvent(name: "switch", value: "off") }
def refresh() { syncCircadian(false) }
def installed() { sendEvent(name: "presence", value: "present") }
