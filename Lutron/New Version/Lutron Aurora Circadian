/**
 * Lutron Aurora Dimmer - Full 6-Schedule Circadian Engine
 * Model: Z3-1BRL
 * Features: Push-to-Sync, 6-Point Schedule, Rotary Debounce
 */

import com.hubitat.zigbee.DataType

metadata {
    definition (name: "Lutron Aurora Dimmer - 6 Schedule", namespace: "absolutelyNothing", author: "absolutelyNothing") {
        capability "Actuator"
        capability "Switch"
        capability "Switch Level"
        capability "Color Temperature"
        capability "Battery"
        capability "Refresh"
        capability "PushableButton"
        capability "Presence Sensor"

        attribute "scene", "string"
        attribute "presence", "string"

        fingerprint profileId: "0104", inClusters: "0000,0001,0003,1000,FC00", outClusters: "0003,0004,0006,0008,0019,1000", manufacturer: "Lutron", model: "Z3-1BRL"
    }

    preferences {
        input(name: "silentTimeAfterPush", type: "number", title: "Ignore rotation after push (ms)", defaultValue: 400)
        
        // --- 6 SCHEDULE CONFIGURATION ---
        section("Morning Transitions") {
            input "s1_start", "string", title: "S1: Early Dawn (Offset from Sunrise)", defaultValue: "-0:30"
            input "s1_temp", "int", title: "S1 Temp (K)", defaultValue: 2237
            
            input "s2_start", "string", title: "S2: Sunrise (Offset from Sunrise)", defaultValue: "0:00"
            input "s2_temp", "int", title: "S2 Temp (K)", defaultValue: 2890
            
            input "s3_start", "string", title: "S3: Morning (Offset from Sunrise)", defaultValue: "1:30"
            input "s3_temp", "int", title: "S3 Temp (K)", defaultValue: 4291
        }
        
        section("Day & Evening Transitions") {
            input "s4_start", "string", title: "S4: Midday (Offset from Sunrise)", defaultValue: "4:30"
            input "s4_temp", "int", title: "S4 Temp (K)", defaultValue: 6410
            
            input "s5_start", "string", title: "S5: Sunset (Offset from Sunset)", defaultValue: "0:00"
            input "s5_temp", "int", title: "S5 Temp (K)", defaultValue: 2890
            
            input "s6_start", "string", title: "S6: Late Night (Offset from Sunset)", defaultValue: "3:00"
            input "s6_temp", "int", title: "S6 Temp (K)", defaultValue: 2237
        }
    }
}

def parse(String description) {
    def event = zigbee.getEvent(description)
    if (event) {
        if (event.name == "battery") sendEvent(name: "battery", value: event.value, unit: "%")
    } else {
        def descMap = zigbee.parseDescriptionAsMap(description)
        if (descMap?.clusterInt == 0x0008) {
            handleRotation(descMap)
        } else if (descMap?.clusterInt == 0x0006) {
            handleButton()
        }
    }
}

def handleRotation(descMap) {
    state.lastMove = now()
    // Debounce to prevent "off-click" from triggering a re-on
    if (state.lastMove - (state.lastPush ?: 0) < (silentTimeAfterPush ?: 400)) return

    int rawValue = Integer.parseInt(descMap.data[0], 16)
    int level = Math.round(rawValue * (100/254))
    
    state.level = level
    syncCircadian() // Push-to-Sync logic
    
    sendEvent(name: "level", value: level, type: "physical")
    sendEvent(name: "switch", value: (level > 0 ? "on" : "off"), type: "physical")
}

def handleButton() {
    state.lastPush = now()
    if (device.currentValue("switch") == "on") {
        sendEvent(name: "switch", value: "off", type: "digital")
    } else {
        syncCircadian()
        sendEvent(name: "switch", value: "on", type: "digital")
    }
}

def syncCircadian() {
    def now = new Date()
    // Calculate all 6 points
    def times = [
        s1: getSunriseAndSunset(sunriseOffset: s1_start).sunrise,
        s2: getSunriseAndSunset(sunriseOffset: s2_start).sunrise,
        s3: getSunriseAndSunset(sunriseOffset: s3_start).sunrise,
        s4: getSunriseAndSunset(sunriseOffset: s4_start).sunrise,
        s5: getSunriseAndSunset(sunsetOffset: s5_start).sunset,
        s6: getSunriseAndSunset(sunsetOffset: s6_start).sunset
    ]
    
    def targetTemp = s6_temp
    def sceneName = "Night"

    if (timeOfDayIsBetween(times.s1, times.s2, now, location.timeZone)) {
        targetTemp = s1_temp
        sceneName = "Early Dawn"
    } else if (timeOfDayIsBetween(times.s2, times.s3, now, location.timeZone)) {
        targetTemp = s2_temp
        sceneName = "Sunrise Sync"
    } else if (timeOfDayIsBetween(times.s3, times.s4, now, location.timeZone)) {
        targetTemp = s3_temp
        sceneName = "Morning Energy"
    } else if (timeOfDayIsBetween(times.s4, times.s5, now, location.timeZone)) {
        targetTemp = s4_temp
        sceneName = "Midday Focus"
    } else if (timeOfDayIsBetween(times.s5, times.s6, now, location.timeZone)) {
        targetTemp = s5_temp
        sceneName = "Evening Wind Down"
    } else {
        targetTemp = s6_temp
        sceneName = "Late Night Relax"
    }

    sendEvent(name: "colorTemperature", value: targetTemp, unit: "K")
    sendEvent(name: "scene", value: sceneName)
}

def on() { syncCircadian(); sendEvent(name: "switch", value: "on") }
def off() { sendEvent(name: "switch", value: "off") }
def refresh() { syncCircadian() }
def installed() { sendEvent(name: "presence", value: "present") }
