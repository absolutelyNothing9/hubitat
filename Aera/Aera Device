/**
 * Aera Diffuser Driver (Child)
 * Author: absolutelyNothing
 */

metadata {
    definition (name: "Aera Diffuser", namespace: "absolutelyNothing", author: "absolutelyNothing") {
        capability "Switch"
        capability "Refresh"
        capability "Actuator"
        capability "Switch Level" // Maps 1-100% to Aera 1-10 intensity

        command "setIntensity", [[name:"Intensity", type: "ENUM", constraints: ["1","2","3","4","5","6","7","8","9","10"]]]

        attribute "Scent", "string"
        attribute "Usage", "string"
        attribute "Firmware", "string"
        attribute "Intensity", "string"
        attribute "cartridgePresence", "string"
    }
}

// --- Standard Capabilities ---

def on() {
    log.info "Aera: Sending ON command"
    parent.sendAylaCommand(device.getDataValue("dsn"), "set_power_state", 1)
}

def off() {
    log.info "Aera: Sending OFF command"
    parent.sendAylaCommand(device.getDataValue("dsn"), "set_power_state", 0)
}

/**
 * Hubitat standard setLevel (1-100)
 * Translates a slider to Aera's 1-10 scale
 */
def setLevel(val) {
    def aeraLvl = Math.max(1, Math.round(val / 10)).toInteger()
    setIntensity(aeraLvl)
}

// --- Aera Specific Commands ---

def setIntensity(val) {
    log.info "Aera: Setting Intensity to ${val}"
    parent.sendAylaCommand(device.getDataValue("dsn"), "intensity_state", val.toInteger())
}

def refresh() {
    log.info "Aera: Refreshing status via SmartApp"
    parent.refreshChildData(device.getDataValue("dsn"))
}

// --- Data Handling ---

/**
 * This is the gateway for the SmartApp to push data into the driver.
 * The SmartApp calls this function whenever it receives a property update from Ayla.
 */
def generateEvent(Map results) {
    log.debug "Aera Driver Received Event: ${results}"
    
    switch(results.name) {
        case "power_state":
            sendEvent(name: "switch", value: (results.value.toInteger() == 1 ? "on" : "off"))
            break
        case "intensity_state":
            sendEvent(name: "Intensity", value: results.value)
            // Also update level for the dashboard slider (10% per step)
            sendEvent(name: "level", value: results.value.toInteger() * 10)
            break
        case "fragrance_name":
            sendEvent(name: "Scent", value: results.value)
            break
        case "cartridge_usage":
            sendEvent(name: "Usage", value: "${results.value}%")
            break
        case "cartridge_present":
            sendEvent(name: "cartridgePresence", value: (results.value.toInteger() == 1 ? "Yes" : "No"))
            break
        case "device_fw_version":
            sendEvent(name: "Firmware", value: results.value)
            break
    }
}

def installed() {
    log.info "Aera Child Driver Installed"
}

def updated() {
    // No login here anymore! 
    log.info "Aera Child Driver Updated"
}
