/**
 * Ayla Networks Integration for Hubitat
 * Author: absolutelyNothing9
 */

definition(
    name: "Ayla Networks Integration",
    namespace: "absolutelyNothing9",
    author: "absolutelyNothing9",
    description: "Integrates Ayla Networks devices with Hubitat Elevation.",
    category: "My Apps",
    iconUrl: "",
    iconX2Url: ""
)

preferences {
    page(name: "mainPage")
    page(name: "authPage")
    page(name: "discoveryPage") // Defined here so it can be called by href
}

def mainPage() {
    return dynamicPage(name: "mainPage", title: "Ayla Networks", install: true, uninstall: true) {
        section("Ayla Credentials") {
            input "username", "text", title: "Ayla Email", required: true
            input "password", "password", title: "Ayla Password", required: true
            input "appId", "text", title: "Ayla App ID", required: true
            input "appSecret", "password", title: "Ayla App Secret", required: true
        }
        
        section("Status") {
            if (state.accessToken) {
                paragraph "Authenticated: **YES**"
            } else {
                paragraph "Status: **Not Connected**"
            }
            href(name: "authLink", title: "1. Test Connection", page: "authPage", description: "Click to authorize with Ayla")
        }

        if (state.accessToken) {
            section("Device Management") {
                href(name: "discoverLink", title: "2. Discover Devices", page: "discoveryPage", description: "Click to find and add your Ayla devices")
            }
        }
    }
}

def authPage() {
    def loginStatus = login()
    return dynamicPage(name: "authPage", title: "Connection Test") {
        section {
            paragraph "${loginStatus}"
        }
    }
}

def discoveryPage() {
    def devices = discoverDevices()
    return dynamicPage(name: "discoveryPage", title: "Device Discovery") {
        section("Found Devices") {
            if (devices && devices.size() > 0) {
                devices.each { devWrapper ->
                    def dev = devWrapper.device // Ayla wraps devices in a "device" object
                    paragraph "Found: **${dev.product_name}**\nDSN: ${dev.dsn}\nModel: ${dev.model}"
                }
            } else {
                paragraph "No devices found. Ensure you are logged in and devices are registered in the Ayla app."
            }
        }
    }
}

// --- Authorization Logic ---

def login() {
    log.debug "Attempting to login to Ayla Networks..."
    def loginUrl = "https://ads-field.aylanetworks.com/users/sign_in.json"
    
    def params = [
        uri: loginUrl,
        headers: ["Content-Type": "application/json"],
        body: [
            user: [
                email: settings.username,
                password: settings.password,
                application: [
                    app_id: settings.appId,
                    app_secret: settings.appSecret
                ]
            ]
        ]
    ]

    try {
        httpPostJson(params) { resp ->
            if (resp.status == 200) {
                state.accessToken = resp.data.access_token
                state.refreshToken = resp.data.refresh_token
                state.tokenExpires = now() + (resp.data.expires_in * 1000)
                return "Successfully connected to Ayla!"
            }
        }
    } catch (e) {
        log.error "Exception during Ayla login: $e"
        return "Error connecting to Ayla: ${e.message}"
    }
}

// --- Discovery Logic ---

def discoverDevices() {
    if (!state.accessToken) return null

    def deviceUrl = "https://ads-field.aylanetworks.com/apiv1/devices.json"
    def params = [
        uri: deviceUrl,
        headers: [
            "Authorization": "auth_token ${state.accessToken}",
            "Content-Type": "application/json"
        ]
    ]

    try {
        httpGet(params) { resp ->
            if (resp.status == 200) {
                def deviceList = resp.data
                deviceList.each { deviceData ->
                    createChildDevice(deviceData)
                }
                return deviceList
            }
        }
    } catch (e) {
        log.error "Discovery failed: $e"
        return null
    }
}

def createChildDevice(deviceData) {
    def dev = deviceData.device
    def dni = "Ayla-${dev.dsn}"
    
    if (!getChildDevice(dni)) {
        try {
            // Namespace 'absolutelyNothing9' used here to match your app
            addChildDevice("absolutelyNothing9", "Ayla Device Handler", dni, [
                "label": dev.product_name ?: "Ayla Device",
                "isComponent": false,
                "name": dev.model
            ])
            log.info "Created child device: ${dni}"
        } catch (e) {
            log.error "Child creation failed. Ensure 'Ayla Device Handler' driver is installed. Error: ${e}"
        }
    }
}

def installed() { initialize() }
def updated() { initialize() }
def initialize() { }
