/**
 * Ayla Networks Multi-Brand Integration (Aera & Nightingale)
 * Author: absolutelyNothing9
 */

definition(
    name: "Ayla Networks Multi-Integration",
    namespace: "absolutelyNothing9",
    author: "absolutelyNothing9",
    description: "Manage Aera and Nightingale devices via Ayla Networks.",
    category: "My Apps",
    iconUrl: "",
    iconX2Url: ""
)

preferences {
    page(name: "mainPage")
    page(name: "authPage")
    page(name: "discoveryPage")
}

def mainPage() {
    return dynamicPage(name: "mainPage", title: "Ayla Networks Multi-Brand", install: true, uninstall: true) {
        
        section("Step 1: Configure Accounts") {
            paragraph "You can configure and authorize both brands. The status will update once a token is received."
            
            // Aera Configuration
            input "aeraEmail", "text", title: "Aera Email", required: false
            input "aeraPass", "password", title: "Aera Password", required: false
            href(name: "authAera", title: "Authorize Aera", page: "authPage", params: [brand: "Aera"], description: getStatus("Aera"))
            
            hr()
            
            // Nightingale Configuration
            input "nightingaleEmail", "text", title: "Nightingale Email", required: false
            input "nightingalePass", "password", title: "Nightingale Password", required: false
            href(name: "authNight", title: "Authorize Nightingale", page: "authPage", params: [brand: "Nightingale"], description: getStatus("Nightingale"))
        }

        if (state.aeraToken || state.nightingaleToken) {
            section("Step 2: Device Discovery") {
                href(name: "discoverLink", title: "Scan for Devices", page: "discoveryPage", description: "Click to find devices for all authorized accounts")
            }
        }
    }
}

def getStatus(brand) {
    def token = (brand == "Aera") ? state.aeraToken : state.nightingaleToken
    return token ? "Status: Connected ✅" : "Status: Not Connected ❌ (Click to Login)"
}

// --- Authorization Page & Logic ---

def authPage(params) {
    def brand = params?.brand ?: params?.obj?.brand // Handle Hubitat param passing
    def result = login(brand)
    
    return dynamicPage(name: "authPage", title: "${brand} Authorization") {
        section {
            paragraph "${result}"
        }
    }
}

def login(brand) {
    if (!brand) return "Error: No brand specified."
    
    log.debug "Attempting login for ${brand}..."
    
    def config = [
        "Aera": [id: "aera-6966028-id", secret: "aera-6966028-secret-N_V_7", user: settings.aeraEmail, pass: settings.aeraPass],
        "Nightingale": [id: "Nightingale-6348421-id", secret: "Nightingale-6348421-secret-M_V_1", user: settings.nightingaleEmail, pass: settings.nightingalePass]
    ]
    
    def target = config[brand]
    if (!target.user || !target.pass) return "Please enter your email and password on the main page first."

    def params = [
        uri: "https://ads-field.aylanetworks.com/users/sign_in.json",
        headers: ["Content-Type": "application/json"],
        body: [
            user: [
                email: target.user,
                password: target.pass,
                application: [app_id: target.id, app_secret: target.secret]
            ]
        ]
    ]

    try {
        httpPostJson(params) { resp ->
            if (resp.status == 200) {
                if (brand == "Aera") state.aeraToken = resp.data.access_token
                else state.nightingaleToken = resp.data.access_token
                
                log.info "${brand} login successful."
                return "${brand} connected successfully!"
            }
        }
    } catch (e) {
        log.error "${brand} login failed: ${e.message}"
        return "Failed to connect to ${brand}. Check credentials and logs."
    }
}

// --- Discovery Logic ---

def discoveryPage() {
    def foundDevices = []
    
    if (state.aeraToken) foundDevices += discoverByBrand("Aera", state.aeraToken)
    if (state.nightingaleToken) foundDevices += discoverByBrand("Nightingale", state.nightingaleToken)
    
    return dynamicPage(name: "discoveryPage", title: "Device Discovery") {
        section("Scan Results") {
            if (foundDevices) {
                foundDevices.each { dev ->
                    paragraph "Found **${dev.brand}** Device: ${dev.name} (DSN: ${dev.dsn})"
                }
            } else {
                paragraph "No devices found. Check your authorizations."
            }
        }
    }
}

def discoverByBrand(brand, token) {
    log.debug "Scanning for ${brand} devices..."
    def results = []
    def params = [
        uri: "https://ads-field.aylanetworks.com/apiv1/devices.json",
        headers: ["Authorization": "auth_token ${token}", "Content-Type": "application/json"]
    ]

    try {
        httpGet(params) { resp ->
            if (resp.status == 200) {
                resp.data.each { item ->
                    def d = item.device
                    createChildDevice(d, brand)
                    results << [brand: brand, name: d.product_name, dsn: d.dsn]
                }
            }
        }
    } catch (e) {
        log.error "Discovery failed for ${brand}: ${e.message}"
    }
    return results
}

def createChildDevice(deviceData, brand) {
    def dni = "Ayla-${deviceData.dsn}"
    if (!getChildDevice(dni)) {
        try {
            // Both brands use the same handler; the handler will check the 'brand' data point
            addChildDevice("absolutelyNothing9", "Ayla Device Handler", dni, [
                "label": "${brand}: ${deviceData.product_name}",
                "isComponent": false,
                "name": deviceData.model,
                "data": [brand: brand, dsn: deviceData.dsn]
            ])
            log.info "Created ${brand} child: ${dni}"
        } catch (e) {
            log.error "Failed to create child: ${e}"
        }
    }
}

def hr() { paragraph "<hr style='background-color:#ccc; height: 1px; border: 0;'>" }
def installed() { initialize() }
def updated() { initialize() }
def initialize() { }
