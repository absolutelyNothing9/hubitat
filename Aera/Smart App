/**
 * Ayla Networks Integration for Hubitat
 * Author: absolutelyNothing9
 */

definition(
    name: "Ayla Networks Integration",
    namespace: "absolutelyNothing9",
    author: "absolutelyNothing9",
    description: "Integrates Ayla Networks devices with Hubitat Elevation.",
    category: "My Apps",
    iconUrl: "",
    iconX2Url: ""
)

preferences {
    page(name: "mainPage")
    page(name: "authPage")
    section("Device Discovery") {
        href(name: "discoverLink", title: "Discover Devices", page: "discoveryPage", description: "Click to find your Ayla devices")
}
}

def mainPage() {
    return dynamicPage(name: "mainPage", title: "Ayla Networks", install: true, uninstall: true) {
        section("Ayla Credentials") {
            input "username", "text", title: "Ayla Email", required: true
            input "password", "password", title: "Ayla Password", required: true
            input "appId", "text", title: "Ayla App ID", required: true
            input "appSecret", "password", title: "Ayla App Secret", required: true
        }
        section("Status") {
            if (state.accessToken) {
                paragraph "Authenticated: YES"
                submitOnChange: true
            } else {
                paragraph "Status: Not Connected"
            }
            href(name: "authLink", title: "Test Connection", page: "authPage", description: "Click to authorize with Ayla")
        }
    }
}

def authPage() {
    def loginStatus = login()
    return dynamicPage(name: "authPage", title: "Connection Test") {
        section {
            paragraph "${loginStatus}"
        }
    }
}

// --- Authorization Logic ---

def login() {
    log.debug "Attempting to login to Ayla Networks..."
    
    // Ayla User API endpoint (Verify your specific region, e.g., US, EU, CN)
    def loginUrl = "https://ads-field.aylanetworks.com/users/sign_in.json"
    
    def params = [
        uri: loginUrl,
        headers: [
            "Content-Type": "application/json"
        ],
        body: [
            user: [
                email: settings.username,
                password: settings.password,
                application: [
                    app_id: settings.appId,
                    app_secret: settings.appSecret
                ]
            ]
        ]
    ]

    try {
        httpPostJson(params) { resp ->
            if (resp.status == 200) {
                state.accessToken = resp.data.access_token
                state.refreshToken = resp.data.refresh_token
                state.tokenExpires = now() + (resp.data.expires_in * 1000)
                log.info "Ayla Auth Successful. Token stored."
                return "Successfully connected to Ayla!"
            } else {
                log.error "Ayla Auth Failed: ${resp.status}"
                return "Login failed. Check logs."
            }
        }
    } catch (e) {
        log.error "Exception during Ayla login: $e"
        return "Error connecting to Ayla: $e"
    }
}

def installed() {
    initialize()
}

def updated() {
    initialize()
}

def initialize() {
    // Schedule token refresh or device discovery here
}


// Add a new page for Discovery
def discoveryPage() {
    def devices = discoverDevices()
    return dynamicPage(name: "discoveryPage", title: "Device Discovery") {
        section("Found Devices") {
            if (devices) {
                devices.each { dev ->
                    paragraph "Found: ${dev.product_name} (DSN: ${dev.dsn})"
                }
            } else {
                paragraph "No devices found or unauthorized."
            }
        }
    }
}

/**
 * Fetches the list of devices associated with the Ayla account.
 */
def discoverDevices() {
    if (!state.accessToken) {
        log.error "No access token found. Please login first."
        return null
    }

    log.debug "Fetching devices from Ayla..."
    
    // Ayla Device Management (ADS) endpoint
    def deviceUrl = "https://ads-field.aylanetworks.com/apiv1/devices.json"
    
    def params = [
        uri: deviceUrl,
        headers: [
            "Authorization": "auth_token ${state.accessToken}",
            "Content-Type": "application/json"
        ]
    ]

    try {
        httpGet(params) { resp ->
            if (resp.status == 200) {
                def deviceList = resp.data
                log.info "Discovered ${deviceList.size()} devices."
                
                // Iterate and create child devices if they don't exist
                deviceList.each { deviceData ->
                    createChildDevice(deviceData)
                }
                return deviceList
            }
        }
    } catch (e) {
        log.error "Discovery failed: $e"
        return null
    }
}

/**
 * Creates a Hubitat Child Device for each Ayla DSN (Device Serial Number)
 */
def createChildDevice(deviceData) {
    def dsn = deviceData.device.dsn
    def label = deviceData.device.product_name
    def dni = "Ayla-${dsn}" // Unique Identifier
    
    def existingDevice = getChildDevice(dni)
    if (!existingDevice) {
        log.info "Creating new child device: ${label} with DNI: ${dni}"
        
        // Note: You must have a Device Driver installed with the name "Ayla Device Handler"
        try {
            addChildDevice("custom", "Ayla Device Handler", dni, [
                "label": label,
                "isComponent": true,
                "name": label
            ])
        } catch (e) {
            log.error "Failed to create child device. Ensure the Driver is installed: ${e}"
        }
    } else {
        log.debug "Device ${dni} already exists."
    }
}
