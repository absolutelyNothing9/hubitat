/**
 * Nightingale Multi-Brand Driver for Hubitat
 */

metadata {
    definition (name: "Nightingale Device Handler", namespace: "absolutelyNothing9", author: "absolutelyNothing9") {
        capability "Switch"
        capability "Refresh"
        capability "AudioVolume" // Standard capability for volume

        command "setRelaxSound", [[name:"Relax Sound", type:"ENUM", description:"Select Nature Sound", constraints:["Crickets","Lakeshore","Loons","Rain","Whales"]]]
        command "setVolume", [[name:"Volume", type: "ENUM", constraints: ["1","2","3","4","5","6","7","8","9","10"] ] ]
        command "setSoundMode", [[name:"Sound Mode", type: "ENUM", constraints: ["Relax","Sleep"] ] ]
        
        // Nightingale Specific Attributes
        attribute "SoundMode", "string"
        attribute "RelaxSound", "string"
        attribute "SleepSound", "string"
        attribute "Volume", "integer"
    }
}

// --- Hubitat Standard Methods ---

def parse(String description) {
    log.debug "Parsing: ${description}"
}

def refresh() {
    log.info "Refresh requested for ${device.label}"
    parent.refreshChildData(device.deviceNetworkId)
}

def on() { setPower("On") }
def off() { setPower("Off") }

// --- API Command Logic ---

void setPower(newPower) {
    def val = (newPower == "On") ? "1" : "0"
    sendAylaCommand("cmd", "{\\\"soundStatus\\\":\\\"${val}\\\"}")
    sendEvent(name: "switch", value: newPower.toLowerCase())
}

void setSoundMode(newMode) {
    def val = (newMode == "Sleep") ? "0" : "1"
    sendAylaCommand("cmd", "{\\\"soundMode\\\":\\\"${val}\\\"}")
    sendEvent(name: "SoundMode", value: newMode)
}

void setVolume(newVol) {
    // Nightingale handles volume via JSON string in the 'cmd' property
    sendAylaCommand("cmd", "{\\\"relaxVolume\\\":\\\"${newVol}\\\",\\\"sleepVolume\\\":\\\"${newVol}\\\"}")
    sendEvent(name: "Volume", value: newVol)
}

void setRelaxSound(sound) {
    def map = [ "Lakeshore": "510", "Crickets": "520", "Loons": "530", "Whales": "540", "Rain": "550" ]
    def val = map[sound]
    if (val) {
        sendAylaCommand("cmd", "{\\\"relaxSound\\\":\\\"${val}\\\"}")
        sendEvent(name: "RelaxSound", value: sound)
    }
}

// --- Helper for Parent Communication ---

private sendAylaCommand(propertyName, value) {
    // We pass the command to the SmartApp because the SmartApp holds the Token
    def dsn = device.getDataValue("dsn")
    parent.sendAylaCommand(dsn, propertyName, value, device.getDataValue("brand"))
}

// This is called by the SmartApp when it gets new data from the cloud
def generateEvent(Map results) {
    log.debug "Driver receiving status update: ${results}"
    // Logic to parse the 'cmd' JSON string from Ayla and update attributes
    if (results.name == "cmd") {
        def slurper = new groovy.json.JsonSlurper()
        def status = slurper.parseText(results.value)
        
        if (status.soundStatus != null) sendEvent(name: "switch", value: status.soundStatus == "1" ? "on" : "off")
        if (status.relaxVolume != null) sendEvent(name: "Volume", value: status.relaxVolume)
    }
}
