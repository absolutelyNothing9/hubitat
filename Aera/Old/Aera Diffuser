/*
 *  Licensed under the Apache License, Version 2.0 (the "License"); you may not
 *  use this file except in compliance with the License. You may obtain a copy
 *  of the License at:
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 *  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 *  License for the specific language governing permissions and limitations
 *  under the License.
 */

import groovy.json.JsonSlurper
import groovy.json.JsonOutput


preferences {
        input "username", "string", title: "Username", required: true
        input "password", "string", title: "Password", required: true
        input "deviceDSN", "string", title: "Device DSN", required: false
		}

metadata {
	definition (name: "Aera Diffuser", namespace: "absolutelyNothing", author: "absolutelyNothing") {
        capability "Switch"
        capability "Refresh"
        capability "Actuator"

        command "refreshProperties"
        command "refreshDevice"
        command "refreshDevices"
        command "refreshToken"
        command "getAccessTokens"
        command "login"

        command "setPower", [[name:"Power On/Off", type: "ENUM", constraints: ["On","Off"] ] ]
        command "setIntensity", [[name:"Volume", type: "ENUM", constraints: ["1","2","3","4","5","6","7","8","9","10"] ] ]

        //command "setIntensityManual", [[name:"Volume", type: "ENUM", constraints: ["1","2","3","4","5","6","7","8","9","10"] ] ]

        attribute "cartridgePresence", "string"
        attribute "Scent", "string"
        attribute "Usage", "integer"
        attribute "Firmware", "string"
        attribute "Intensity", "string"
        attribute "Authorization", "Date"
        attribute "Cartridge_Usage", "string"
	}

}


def allPurposeFlour(response, data) {
        log.debug "status of post call is: ${response.status}"
        log.info "${response.data}"

}
def getDevice(response, data) {
      log.debug "status of post call is: ${response.status}"
        log.info "${response.data}"
        Map deviceProperties = new 
            groovy.json.JsonSlurper().parseText(response.json.getAt(3).property.value)
    


    def cartridge_present = "${deviceProperties.cartridge_present == 0 ? "No" : reportValue == 1 ? "Yes": "error"}"
        sendEvent(name: "cartridgePresence", value: cartridge_present)
    


 }


def installed() {

    refresh()
    unschedule()
    state.deviceDSN = deviceDSN
    state.email= "email"
    state.password = "password"

}

////Refresh
def refresh() {
    schedule("0 0 2/23 ? * * *", refresh)
    Map postParams = [ uri: "https://user-field.aylanetworks.com/users/refresh_token", requestContentType: "application/json", contentType: "application/json", body: new groovy.json.JsonOutput().toJson( [ user: [ refresh_token: state.refreshToken ] ] ) ]
    asynchttpPost('signIn', postParams)
    //log.debug("postParams: ${postParams}")
}

////Email Login
def login() {

Map postParams = [ uri: "https://fxn.requestcatcher.com/", requestContentType: "application/json", contentType: "application/json", body: new groovy.json.JsonOutput().toJson( [ user: [ email: username, password: password, application:[app_id: "ios-id", app_secret: "ios-id-7h0tftiMcjIP-a0URU-pwxFbi4I"] ] ] ) ]

    asynchttpPost('signIn', postParams)
}
////Email Login
def getAccessTokens() {

Map postParams = [ uri: "https://fxn.requestcatcher.com/", requestContentType: "application/json", contentType: "application/json", body: new groovy.json.JsonOutput().toJson( [ user: [ email: email, password: password ] ] ) ]

    asynchttpPost('signIn', postParams)
}
def getAccessTokens2() {
def postParams = [

        uri: "https://user-field.aylanetworks.com/users/sign_in",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            body: '{"user": {"email": "andyjarmijo@gmail.com","password": "Diseased1!","application" :{"app_id": "ios-id-id","app_secret": "ios-id-7h0tftiMcjIP-a0URU-pwxFbi4I"}}'
           
                  ]
    
    asynchttpPost('signIn', postParams)
}
//Sign In
def signIn(response, data) {
        if(response.status == 200)
            {
                jsonMap = response.data
                if (response.data) {
                    state.refreshToken = response.json.refresh_token
                    state.accessToken = response.json.access_token
                    state.session = now() + 86400
            }
        //log.info "Acess Token is ${state.accessToken}"
        //log.info "Refresh Token is ${state.refreshToken}"
        //log.info "Expiration is ${state.session}"
        //log.info "Aera Credentials Refreshed"
        sendEvent(name: "Authorization", value: new Date().format("MMM dd yyyy hh:mm a", location.timeZone), descriptionText: "Aera Credentials Refreshed.")
    
}
}

////Refresh Devices
def refreshDevices() {
    def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/devices",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"]
                  ]
    asynchttpGet('allPurposeFlour', postParams)
}
def getDevices(response, data) {
        log.trace "status of post call is: ${response.status}"
        log.info "${response.data}"
        log.info "${response.json.find {it.property.name == "device"}.dsn}"

}
//refresh properties
void refreshProperties() {
    def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}"]
                  ]
    asynchttpGet('getProperties', postParams)
}
def getProperties(response, data) {
    if(response.status == 200){
    log.info "${response.json.find {it.property.name == "cartridge_present"}.property.value}"
        
    def cartridge_present = "${response.json.find {it.property.name == "cartridge_present"}.property.value == 1 ? "Yes" : "No"}"
        sendEvent(name: "cartridgePresence", value: cartridge_present)
        
    def cartridge_usage = "${response.json.find {it.property.name == "cartridge_usage"}.property.value}"
        sendEvent(name: "Usage", value: cartridge_usage)

    def device_fw_version = "${response.json.find {it.property.name == "device_fw_version"}.property.value}"
        sendEvent(name: "Firmware", value: device_fw_version)

    def fragrance_name = "${response.json.find {it.property.name == "fragrance_name"}.property.value}"
        sendEvent(name: "Scent", value: fragrance_name)
   
    def intensity_state = "${response.json.find {it.property.name == "intensity_state"}.property.value}"
        sendEvent(name: "Intensity", value: intensity_state)
    
    def power_state = "${response.json.find {it.property.name == "power_state"}.property.value == 1 ? "On" : "Off"}"
        sendEvent(name: "switch", value: power_state)

    //def set_intensity_manual = "${response.json.find {it.property.name == "set_intensity_manual"}.property.value}"
        //sendEvent(name: "Intensity.Manual", value: set_intensity_manual)
    }
} 

////Power Modes
def off() {
    def postParams = [
            uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_power_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}"],
            body: '{"datapoint": {"value": 0}}'
                  ]
    asynchttpPost('allPurposeFlour', postParams)
    sendEvent(name: "switch", value: "Off")
}          
def on() {
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_power_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 1}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "switch", value: "On")
}
void setPower(newPower) {
	switch (newPower) {
	case "On":
        def postParams = [
            uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_power_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 1}}'
                  ]
    
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "switch", value: "On")
    break ;
	case "Off":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_power_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 0}}'
                  ]
    
        asynchttpPost('allPurposeFlour', postParams)
        sendEvent(name: "switch", value: "Off")
	break ;
	}

}
////Intensity
void setIntensity(newInt) {
	switch (newInt) {
        case "1":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 1}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "1")
		break ;
        case "2":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 2}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "2")
		break ;
        case "3":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 3}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "3")
		break ;
        case "4":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 4}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "4")
		break ;
        case "5":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
             body: '{"datapoint": {"value": 5}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "5")
		break ;
        case "6":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 6}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "6")
		break ;
        case "7":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 7}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "7")
		break ;
        case "8":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 8}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "8")
		break ;

	case "9":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/intensity_state/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 9}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "9")
		break ;
    case "10":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 10}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity", value: "10")
		break ;
	}
}

////Manual Intensity
void setIntensityManual(newManInt) {
	switch (newManInt) {
        case "1":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 1}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "1")
		break ;
        case "2":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 2}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "2")
		break ;
        case "3":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 3}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "3")
		break ;
        case "4":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            body: '{"datapoint": {"value": 4}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "4")
		break ;
        case "5":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 5}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "5")
		break ;
        case "6":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 6}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "6")
		break ;
        case "7":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 7}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "7")
		break ;
        case "8":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 8}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "8")
		break ;

	case "9":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 9}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "9")
		break ;
    case "10":
        def postParams = [
        uri: "https://ads-field.aylanetworks.com/apiv1/dsns/${deviceDSN}/properties/set_intensity_manual/datapoints",
		    requestContentType: 'application/json',
		    contentType: 'application/json',
            headers: ["Authorization": "Bearer ${state.accessToken}","User-Agent": "Prolitec/1.5.4 (iPhone; iOS 14.4; Scale/3.00)"],
            body: '{"datapoint": {"value": 10}}'
                  ]
            asynchttpPost('allPurposeFlour', postParams)
            sendEvent(name: "Intensity.Manual", value: "10")
		break ;
	}
}
