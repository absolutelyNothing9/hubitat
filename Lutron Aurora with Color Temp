/**
 *  Partly based on source originally copyright 2018-2019 SmartThings
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except
 *  in compliance with the License. You may obtain a copy of the License at:
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software distributed under the License is distributed
 *  on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License
 *  for the specific language governing permissions and limitations under the License.
 *
 */

import com.hubitat.zigbee.DataType

preferences {
    input(name: "editSchedules", type: "bool", title: "Circadian Schedules", defaultValue: false, submitOnChange: true, displayDuringSetup: true)
    input(name: "levelAndOff", type: "bool", title: "Custom Level/Off Settings", defaultValue: false, submitOnChange: true, displayDuringSetup: true)
    input(name: "customSpeed", type: "bool", title: "Custom Speed Settings", defaultValue: false, submitOnChange: true, displayDuringSetup: true)
    input(name: "debug", type: "bool", title: "Enable debug logging", defaultValue: false, submitOnChange: true)
    input(name: "overallMotion", type: "bool", title: "Enable Motion Timeouts", defaultValue: false, submitOnChange: true)

if(levelAndOff){
    input("timer", "integer", title: "Occupancy Timeout in Seconds", description: "How long after Physical interaction", defaultValue: 3600,  required: false)
    input(name: "autoOffDuration", type: "enum", title: "Auto turn off", defaultValue: 0, required: true, multiple: false, options:[0:"Disabled", 1:"30 Minutes", 2:"45 Minutes", 5:"1 Hour"]) 
    input name: "levelChangeRate", type: "enum", title: '"Start level change" rate', options:
         [["slow":"Slow"],["medium":"Medium"],["fast":"Fast (default)"]], defaultValue: "fast"  
}
if(editSchedules){
    input(name: "circadian", type: "bool", title: "Enable Circadian Transitions", description: "", defaultValue: false, submitOnChange: true)
    input(name: "transitionChecker", type: "bool", title: "Show/Edit Transition Schedule", description: "For Lights Already On", defaultValue: false, submitOnChange: true)
    input(name: "schedule1", type: "bool", title: "Show/Edit Schedule 1", defaultValue: false, submitOnChange: true)
    input(name: "schedule2", type: "bool", title: "Show/Edit Schedule 2", defaultValue: false, submitOnChange: true)
    input(name: "schedule3", type: "bool", title: "Show/Edit Schedule 3", defaultValue: false, submitOnChange: true)
    input(name: "schedule4", type: "bool", title: "Show/Edit Schedule 4", defaultValue: false, submitOnChange: true)
    input(name: "schedule5", type: "bool", title: "Show/Edit Schedule 5", defaultValue: false, submitOnChange: true)
    input(name: "schedule6", type: "bool", title: "Show/Edit Schedule 6", defaultValue: false, submitOnChange: true)
}


if(schedule1) {
    input(name: "schedule1scene", type: "string", title: "Schedule 1 Scene", defaultValue: "Energize")
    input(name: "schedule1start", type: "string", title: "Schedule 1 Start", defaultValue: "07:30", submitOnChange: true)
    input(name: "schedule1end", type: "string", title: "Schedule 1 End", defaultValue: "10:00", submitOnChange: true)
    input(name: "schedule1colorTemp", type: "number", title: "Schedule 1 Color Temp", defaultValue: "6410",  unit:  "K")
    input(name: "schedule1level", type: "number", title: "Schedule 1 Level",  defaultValue: "100") 
    input(name: "schedule1motionBool", type: "bool", title: "Motion Timeouts",  defaultValue: true) 
       if(schedule1motionBool) input(name: "schedule1motion", type: "number", title: "Schedule 1 Motion Timeout",  defaultValue: "120") 
    }
if(schedule2) {
    input(name: "schedule2scene", type: "string", title: "Schedule 2 Scene", defaultValue: "Concentrate")
    input(name: "schedule2start", type: "string", title: "Schedule 2 Start", defaultValue: "10:00", submitOnChange: true)
    input(name: "schedule2end", type: "string", title: "Schedule 2 End", defaultValue: "17:00", submitOnChange: true)
    input(name: "schedule2colorTemp", type: "number", title: "Schedule 2 Color Temp", defaultValue: "4291",  unit:  "K")
    input(name: "schedule2level", type: "number", title: "Schedule 2 Level", defaultValue: "100")  
    input(name: "schedule2motionBool", type: "bool", title: "Motion Timeouts",  defaultValue: true) 
       if(schedule2motionBool) input(name: "schedule2motion", type: "number", title: "Schedule 2 Motion Timeout",  defaultValue: "300") 
}
if(schedule3) {
    input(name: "schedule3scene", type: "string", title: "Schedule 3 Scene", defaultValue: "Read") 
    input(name: "schedule3start", type: "string", title: "Schedule 3 Start", defaultValue: "17:00", submitOnChange: true)
    input(name: "schedule3end", type: "string", title: "Schedule 3 End", description: "", defaultValue: "20:00", submitOnChange: true)
    input(name: "schedule3colorTemp", type: "number", title: "Schedule 3 Color Temp", description: "", defaultValue: "2890",  unit:  "K")
    input(name: "schedule3level", type: "number", title: "Schedule 3 Level", defaultValue: "100")  
    input(name: "schedule3motionBool", type: "bool", title: "Motion Timeouts",  defaultValue: true) 
        if(schedule3motionBool) input(name: "schedule3motion", type: "number", title: "Schedule 4 Physical Motion Timeout",  defaultValue: "600")
        if(schedule3motionBool) input(name: "schedule3motionD", type: "number", title: "Schedule 3 Digital Motion Timeout",  defaultValue: "600")
}    
if(schedule4) {
    input(name: "schedule4scene", type: "string", title: "Schedule 4 Scene", defaultValue: "Relax")
    input(name: "schedule4start", type: "string", title: "Schedule 4 Start", defaultValue: "20:00", submitOnChange: true)
    input(name: "schedule4end", type: "string", title: "Schedule 4 End", defaultValue: "23:00", submitOnChange: true)
    input(name: "schedule4colorTemp", type: "number", title: "Schedule 4 Color Temp", defaultValue: "2237",  unit:  "K")
    input(name: "schedule4level", type: "number", title: "Schedule 4 Level", defaultValue: "60")  
    input(name: "schedule4motionBool", type: "bool", title: "Motion Timeouts",  defaultValue: true) 
        if(schedule4motionBool) input(name: "schedule4motion", type: "number", title: "Schedule 4 Physical Motion Timeout",  defaultValue: "120") 
        if(schedule4motionBool) input(name: "schedule4motionD", type: "number", title: "Schedule 4 Digital Motion Timeout",  defaultValue: "120")
}    
if(schedule5) {
    input(name: "schedule5scene", type: "string", title: "Schedule 5 Scene", defaultValue: "Nightlight")
    input(name: "schedule5start", type: "string", title: "Schedule 5 Start", defaultValue: "23:00", submitOnChange: true)
    input(name: "schedule5end", type: "string", title: "Schedule 5 End", defaultValue: "24:00", submitOnChange: true)
    input(name: "schedule5colorTemp", type: "number", title: "Schedule 5 Color Temp", defaultValue: "1700",  unit:  "K")
    input(name: "schedule5level", type: "number", title: "Schedule 5 Level", defaultValue: "20")  
    input(name: "schedule5motionBool", type: "bool", title: "Motion Timeouts",  defaultValue: true) 
        if(schedule5motionBool) input(name: "schedule5motion", type: "number", title: "Schedule 5 Physical Motion Timeout",  defaultValue: "60") 
        if(schedule5motionBool) input(name: "schedule5motionD", type: "number", title: "Schedule 5 Digital Motion Timeout",  defaultValue: "60")
}    
if(schedule6) {
    input(name: "schedule6scene", type: "string", title: "Schedule 6 Scene", defaultValue: "Nightlight")
    input(name: "schedule6start", type: "string", title: "Schedule 6 Start", defaultValue: "00:00", submitOnChange: true)
    input(name: "schedule6end", type: "string", title: "Schedule 6 End", defaultValue: "07:30", submitOnChange: true)
    input(name: "schedule6colorTemp", type: "number", title: "Schedule 6 Color Temp", defaultValue: "1700",  unit:  "K")
    input(name: "schedule6level", type: "number", title: "Schedule 6 Level", defaultValue: "20") 
    input(name: "schedule6motionBool", type: "bool", title: "Motion Timeouts",  defaultValue: true) 
        if(schedule6motionBool) input(name: "schedule6motion", type: "number", title: "Schedule 6 Physical Motion Timeout",  defaultValue: "60") 
        if(schedule6motionBool) input(name: "schedule6motionD", type: "number", title: "Schedule 6 Digital Motion Timeout",  defaultValue: "60")
    }
if(transitionChecker) {
    input(name: "transition1scene", type: "string", title: "Transition 1 Ending Scene", description: "", defaultValue: "Energize")
    input(name: "transition1start", type: "string", title: "Transition 1 Start", description: "", defaultValue: "7:00", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition1end", type: "string", title: "Transition 1 End", description: "", defaultValue: "7:30", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition1colorBool", type: "bool", title: "Change Color Temp At Schedule 1 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition1colorBool){input(name: "transition1colorTemp", type: "number", title: "Transition 1 Color Temp", description: "", defaultValue: "6410",  unit:  "K")}
    input(name: "transition1levelBool", type: "bool", title: "Change Level At Schedule 1 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition1levelBool){input(name: "transition1level", type: "number", title: "Transition 1 Ending Level", description: "", defaultValue: "100")} 
    input(name: "transition2scene", type: "string", title: "Transition 2 Ending Scene", description: "", defaultValue: "Concentrate")
    input(name: "transition2start", type: "string", title: "Transition 2 Start", description: "", defaultValue: "9:30", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition2end", type: "string", title: "Transition 2 End", description: "", defaultValue: "10:00", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition2colorBool", type: "bool", title: "Change Color Temp At Schedule 2 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition2colorBool){input(name: "transition2colorTemp", type: "number", title: "Transition 2 Ending Color Temp", description: "", defaultValue: "4291",  unit:  "K")}
    input(name: "transition2levelBool", type: "bool", title: "Change Level At Schedule 2 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition2levelBool){input(name: "transition2level", type: "number", title: "Transition 2 Ending Level", description: "", defaultValue: "100")}
    input(name: "transition3scene", type: "string", title: "Transition 3 Ending Scene", description: "", defaultValue: "Read")
    input(name: "transition3start", type: "string", title: "Transition 3 Start", description: "", defaultValue: "16:30", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition3end", type: "string", title: "Transition 3 End", description: "", defaultValue: "17:00", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition3colorBool", type: "bool", title: "Change Color Temp At Schedule 3 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition3colorBool){input(name: "transition3colorTemp", type: "number", title: "Transition 3 Ending Color Temp", description: "", defaultValue: "2890",  unit:  "K")}
    input(name: "transition3levelBool", type: "bool", title: "Change Level At Schedule 3 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition3levelBool){input(name: "transition3level", type: "number", title: "Transition 3 Ending Level", description: "", defaultValue: "100")}
    input(name: "transition4scene", type: "string", title: "Transition 4 Scene", description: "", defaultValue: "Relax")
    input(name: "transition4start", type: "string", title: "Transition 4 Start", description: "", defaultValue: "19:30", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition4end", type: "string", title: "Transition 4 End", description: "", defaultValue: "20:00", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition4colorBool", type: "bool", title: "Change Color Temp At Schedule 4 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition4colorBool){input(name: "transition4colorTemp", type: "number", title: "Transition 4 Color Temp", description: "", defaultValue: "2237",  unit:  "K")}
    input(name: "transition4levelBool", type: "bool", title: "Change Level At Schedule 4 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition4levelBool){input(name: "transition4level", type: "number", title: "Transition 4 Level", description: "", defaultValue: "60")} 
    input(name: "transition5scene", type: "string", title: "Transition 5 Scene", description: "", defaultValue: "Nightlight")
    input(name: "transition5start", type: "string", title: "Transition 5 Start", description: "", defaultValue: "22:30", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition5end", type: "string", title: "Transition 5 End", description: "", defaultValue: "23:00", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition5colorBool", type: "bool", title: "Change Color Temp At Schedule 5 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition5colorBool){input(name: "transition5colorTemp", type: "number", title: "Transition 5 Color Temp", description: "", defaultValue: "1700",  unit:  "K")}
    input(name: "transition5levelBool", type: "bool", title: "Change Level At Schedule 5 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition5levelBool){input(name: "transition5level", type: "number", title: "Transition 5 Level", description: "", defaultValue: "20")  }
    input(name: "transition6scene", type: "string", title: "Schedule 6 Scene", description: "", defaultValue: "Nightlight")
    input(name: "transition6start", type: "string", title: "Schedule 6 Start", description: "", defaultValue: "00:00", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition6end", type: "string", title: "Schedule 6 End", description: "", defaultValue: "07:30", submitOnChange: true, displayDuringSetup: false, required: false)
    input(name: "transition6colorBool", type: "bool", title: "Change Color Temp At Schedule 6 Time?", description: "", defaultValue: ftrue, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition6colorBool){input(name: "transition6colorTemp", type: "number", title: "Schedule 6 Color Temp", description: "", defaultValue: "1700",  unit:  "K")}
    input(name: "transition6levelBool", type: "bool", title: "Change Level At Schedule 6 Time?", description: "", defaultValue: true, submitOnChange: true, displayDuringSetup: false, required: false)
        if(transition6levelBool){input(name: "transition6level", type: "number", title: "Schedule 6 Level", description: "", defaultValue: "20")  }
}

if(customSpeed) {
    input(name: "useDeviceSpeed", type: "bool", title: "Use level change speed from the physical device", description: "Not recommended", defaultValue: false)
    input(name: "silentTimeAfterClick", type: "number", title: "Ignore rotation after a click", description: "In milliseconds, due to a device bug, see docs.", defaultValue: "300", range: "1..2000")
    input(name: "speedFastestThreshold", type: "number", title: "Fastest speed threshold", description: "In milliseconds", defaultValue: "25", range: "1..1000")
    input(name: "speedFastThreshold", type: "number", title: "Fast speed threshold", description: "In milliseconds", defaultValue: "100", range: "1..1000")
    input(name: "speedMediumThreshold", type: "number", title: "Medium speed threshold", description: "In milliseconds", defaultValue: "200", range: "1..1000")
    input(name: "speedLowThreshold", type: "number", title: "Low speed threshold", description: "In milliseconds", defaultValue: "300", range: "1..1000")
    input(name: "speedFastestIncrement", type: "number", title: "Fastest speed increment", description: "In level %", defaultValue: "12", range: "1..100")   
    input(name: "speedFastIncrement", type: "number", title: "Fast speed increment", description: "In level %", defaultValue: "8", range: "1..100") 
    input(name: "speedMediumIncrement", type: "number", title: "Medium speed increment", description: "In level %", defaultValue: "4", range: "1..100")    
    input(name: "speedLowIncrement", type: "number", title: "Low speed increment", description: "In level %", defaultValue: "2", range: "1..100")   
    }

}
metadata {
	definition (name: "Lutron Aurora Dimmer with Color Temperature", namespace: "absolutelyNothing", author: "absolutelyNothing") {
		capability "Actuator"
		capability "Switch"
		capability "Switch Level"
        capability "LightEffects"
        capability "LevelPreset"
        capability "ChangeLevel"
		capability "Configuration"
        capability "Color Control"
        capability "Color Temperature"
        capability "Motion Sensor"
        capability "Presence Sensor"
        capability "Refresh"
        capability "PushableButton"
		capability "DoubleTapableButton"
		capability "HoldableButton"

        //command "push", ["number"]
        command "showSettings"
        command "areLightsOn"
        command "buttonPressLogic"
        command "physicalTimeOfDay"
        command "motionTimeOfDay"
        command "digitalTimeOfDay"
        command "clearPush"
        command "enableCircadianSchedule"
        command "disableCircadianSchedule"
        command "push", ["number"]


        command "enableColorChanges"
        command "disableColorChanges"
        command "enableLevelChanges"
        command "disableLevelChanges"
        command "showSchedules"

        command "setEnergize"
        command "setConcentrate"
        command "setRead"
        command "setRelax"
        command "setNightlight"
        command "setNight"
	    command "setScene", [[name:"scene", type:"ENUM", description:"Select Scene", constraints:[0:"Energize", 1:"Concentrate", 2:"Read", 3:"Relax", 4:"Nightlight"]]]
        command "setMotionInactive"        
        command "setMotionActive"


        attribute "scene", "string"
        attribute "battery", "integer"
        attribute "Circadian Schedules","bool"
        attribute "Level Changes","bool"
        attribute "Color Changes","bool"

		fingerprint profileId: "0104", inClusters: "0000,0001,0003,1000,FC00", outClusters: "0003,0004,0006,0008,0019,1000", manufacturer: "Lutron", model: "Z3-1BRL"	}
}
    



void startLevelChange(String direction) {
    logging("startLevelChange(direction: ${direction})", 100)
    sendZigbeeCommands(zigbeeStartLevelChange(retrieveEndpointId(), direction, 64))
}

void stopLevelChange() {
    logging("stopLevelChange()", 100)
    sendZigbeeCommands(zigbeeStopLevelChange(retrieveEndpointId()))
}

//Color
private void setGenericName(hue){
    String colorName
    hue = hue.toInteger()
    hue = (hue * 3.6)
    switch (hue.toInteger()){
        case 0..15: colorName = "Red"
            break
        case 16..45: colorName = "Orange"
            break
        case 46..75: colorName = "Yellow"
            break
        case 76..105: colorName = "Chartreuse"
            break
        case 106..135: colorName = "Green"
            break
        case 136..165: colorName = "Spring"
            break
        case 166..195: colorName = "Cyan"
            break
        case 196..225: colorName = "Azure"
            break
        case 226..255: colorName = "Blue"
            break
        case 256..285: colorName = "Violet"
            break
        case 286..315: colorName = "Magenta"
            break
        case 316..345: colorName = "Rose"
            break
        case 346..360: colorName = "Red"
            break
    }
    String descriptionText = "${device.getDisplayName()} color is ${colorName}"
    eventProcess(name: "colorName", value: colorName ,descriptionText: descriptionText)
}
def setColor(value) {
	log("Begin setting groups color to ${value}.", "DEBUG")
    def hue = value.hue.toInteger() * 3.6
    def sat = value.saturation.toInteger() / 100
    def level = value.level.toInteger()
    if(level) setLevel(level)

    sendEvent(name: "hue", value: value.hue, displayed: getUseActivityLogDebug())
    sendEvent(name: "saturation", value: value.saturation, displayed: getUseActivityLogDebug())
    sendEvent(name: "color", value: value.hex, displayed: getUseActivityLogDebug())
    sendEvent(name: "switch", value: "on")
    sendEvent(name: "level", value: "${state.level}")
}


def configure() {
    zigbee.onOffConfig() + 
        zigbee.levelConfig() +
        zigbee.enrollResponse() + 
        zigbee.readAttribute(zigbee.POWER_CONFIGURATION_CLUSTER, 0x20)
}





def handleLevelEvent(descMap) {
    state.changeTime = now()
    if (state.changeTime - state.lastClick < silentTimeAfterClick) {
        if (debug) log.debug "Ignoring level even under ${silentTimeAfterClick}ms after a click"
        return
    }

    int deviceLevel = descMap.data.size() < 3 ? 0 : Integer.parseInt(descMap.data[0], 16) * (100/254)
    calculateSpeed(deviceLevel)
    
    if (deviceLevel > state.previousDeviceLevel || (deviceLevel == 100 && state.previousDeviceLevel == 100)) {
        if (debug) log.debug "Increasing driver level"
        state.level = state.level + state.speed
        setLevelPhysical(state.level + state.speed)
    } else if (deviceLevel < state.previousDeviceLevel || (deviceLevel == 0 && state.previousDeviceLevel == 0)) {
        if (debug) log.debug "Decreasing driver level"
        state.level = state.level - state.speed
        setLevelPhysical(state.level - state.speed)
    }
    state.previousDeviceLevel = deviceLevel
    if (state.level > 100) {
        if (debug) log.debug "Limiting driver level to 100"
        state.level = 100;
    } else if (state.level < 0) {
        if (debug) log.debug "Limiting driver level to 0"
        state.level = 0;
    }
    log.debug "Device level = ${deviceLevel}"
    log.debug "Driver level = ${state.level}%"
    
}

def calculateSpeed(deviceLevel) {
    if (useDeviceSpeed && deviceLevel - state.previousDeviceLevel != 0) {
        state.speed = Math.abs(deviceLevel - state.previousDeviceLevel);
        log.debug "Device speed is ${state.speed}"
        return
    }
    long intervalMillis = state.changeTime - state.previousChangeTime

    if (intervalMillis <= speedFastestThreshold) {
        state.speed = speedFastestIncrement
    } else if (intervalMillis <= speedFastThreshold) {
        state.speed = speedFastIncrement
    } else if (intervalMillis <= speedMediumThreshold) {
        state.speed = speedMediumIncrement
    } else if (intervalMillis <= speedLowThreshold) {
        state.speed = speedLowIncrement
    } else {
        state.speed = 1
    }
    state.previousChangeTime = state.changeTime
    log.debug "Calculated speed is ${state.speed} (${intervalMillis}ms)"
}



                                                                                                                                                    //PARSE
def parse(String description) {
	if (debug) log.debug "description = $description"
	def event = zigbee.getEvent(description)
	if (event) {
        if (event.name == "battery") {
            sendEvent(name: event.name, value: event.value, unit: "%", isStateChange: false)
            log.debug "Battery event registered properly ${event}"
        }
		if (event.name=="level" && event.value==0) {
            log.info "$device level = 0"
        } else {
            if (debug) log.trace "sending ${event}"
		        }
	} else {
		def descMap = zigbee.parseDescriptionAsMap(description)
        if (descMap && descMap.clusterInt == 0x008) {
               log.debug "8 data = ${descMap.data}"
            def dataList = descMap.data
            if (dataList.size() < 3) {
               if (debug) log.debug  "Ignoring data ${dataList}"
            } else {         
                //handleLevelEvent(descMap)
                int deviceLevel = Integer.parseInt(descMap.data[0], 16) * (100/254)
                //colorTimeOfDay()
                setLevelPhysical(deviceLevel)
                log.info "$device level = ${deviceLevel}"                
			    
            }            
        } else if (descMap && descMap.clusterInt == 0x0006) {   
            if (debug) log.trace "Any Button Press/Hold/Double Tap ${descMap}"
            buttonPressLogic()

            //if (device.currentValue("switch") == "off"){timeOfDay()} 
            //sendEvent(name: "switch", value: device.currentValue("switch") == "on" ? "off" : "on", type: "physical", descriptionText: "$device switch was ${device.currentValue("switch")}.")
			//sendEvent(name: "pushed", value: value, type: "physical", isStateChange: true, descriptionText: "$device button 1 was pushed")	
		} else {
			if (debug) log.warn "DID NOT PARSE MESSAGE for description : $description"
			if (debug) log.debug "${descMap}"
		}
	}
}

def showSettings() {
    log.info("$settings")
}

def refresh (){
//Schedule Color Temp Checks at 7/7:30, 10/10:30, 5/5:30, 8/8:30, 11/11:30
    if (circadian) schedule("0 0,30 7,10,17,20,23 ? * * *", areLightsOn)
    unschedule()
    device.clearSetting()
    //unschedule(areLightsOn) 
    def date = new Date(schedule6end)

    def tramp = date.format('HH:mm', location.timeZone)
    log.warn tramp

    schedule("0 30 2/23 ? * * *", refresh)       
    state.pushes = 0 
        

//    log.debug location.mode
     state.remove("pushes")
//    state.remove("switch")
//    settings.remove("enableAutomaticGetInfo")

    //state.previousDeviceLevel = 0
    //state.speed = 1
    //state.level = 0
    //state.lastClick = 0;
    //state.changeTime = 0;
    //state.previousChangeTime = 0;
  
}
def installed() {
    sendEvent(name: "switch", value: "on", displayed: false)
	sendEvent(name: "level", value: "50", displayed: false) 
	sendEvent(name: "pushed", value: 4, displayed: true)
	sendEvent(name: "numberOfButtons", value: 1, displayed: false)1
    sendEvent(name: "scene", value: null, displayed: false)
    sendEvent(name: "presence", value: "present", displayed: false)
}
//Transition Events
def transition1
def transition2
def transition3
def transition4
def transition5
def transition6


def enableColorChanges
def disableColorChanges
def enableLevelChanges

def disableLevelChanges() {
state.levelChanges =  false
}


//Buttons
def push() {
    if (debug) log.trace "Single Push Registered"
    if (device.currentValue("switch") == "off"){
        log.trace "$device was Off when pushed"
        physicalTimeOfDay()
     }
     else if(device.currentValue("switch")== "on"){
        if (debug) log.trace "$device was On when pushed"
        sendEvent(name: "switch", value: "off", isStateChange: true, type: "physical", descriptionText: "$device turned off physically.")
     }
    sendEvent(name: "pushed", value: value, type: "physical", isStateChange: true, descriptionText: "$device button was pushed")
}
def doubleTap() {
    if (debug) log.trace "double tap registered"
    sendEvent("name": "doubleTapped", "value":  1, isStateChange: true, type: "physical", descriptionText: "$device was double tapped")
}
def hold() {
    sendEvent("name": "held", "value":  1, isStateChange: true, type: "physical", descriptionText: "$device was double held")
}
//Pyshical Commands
///Physical Button Press Logic	 
def buttonPressLogic()	{
    state.previousLastClick = state.lastClick
    state.lastClick = now()
    runInMillis(400, "buttonPressLogic2")
    occupied()
}
def buttonPressLogic2() {
 if (state.lastClick - state.previousLastClick < silentTimeAfterClick){
    //if (state.pushes == 1){
        if (debug) log.trace "it was quick"
        doubleTap()
        return
        }else if (state.lastClick - state.previousLastClick > silentTimeAfterClick){
        //    } else if (state.lastClick - state.previousLastClick > silentTimeAfterClick){
        push()
    }
    state.remove("previousLastClick")
}


//Physical Level
def setLevelPhysical(value, rate = null) {
    state.level = value
	if (value == 0) {
	sendEvent(name: "switch", value: "off", isStateChange: true, type: "physical", descriptionText: "$device dimmmed off physically.")
	} else {

    sendEvent(name: "switch", value: "on", type: "physical", descriptionText: "$device dimmmed on physically.")
    }
    sendEvent(name: "level", value: value, type: "physical")  	
    occupied()
}
//Schedule for Pyhsical Touch
void physicalTimeOfDay() {
    if (debug) log.trace "Time of Day from Physical Touch"
    //Date currTimeD, startTimeD1, endTimeD1, startTimeD2, endTimeD2, startTimeD3, endTimeD3, startTimeD4, endTimeD4, startTimeD5, endTimeD5, transition1start
    currTimeD = new Date()
    //energize 7:30 - 10
    schedule1start = timeToday(schedule1start, location.timeZone)
    schedule1end = timeToday(schedule1end, location.timeZone)
    //concentrate 10 - 5
    schedule2start = timeToday(schedule2start, location.timeZone)
    schedule2end = timeToday(schedule2end, location.timeZone)
    //read 5 - 8
    schedule3start = timeToday(schedule3start, location.timeZone)
    schedule3end = timeToday(schedule3end, location.timeZone)
    //relax 8 - 11
    schedule4start = timeToday(schedule4start, location.timeZone)
    schedule4end = timeToday(schedule4end, location.timeZone)
    //nightlight 11 - 12
    schedule5start = timeToday(schedule5start , location.timeZone)
    schedule5end = timeToday(schedule5end, location.timeZone)
    //nightlight 12 - 7:30
    schedule6start = timeToday(schedule6start, location.timeZone)
    schedule6end = timeToday(schedule6end, location.timeZone)
    

    if( timeOfDayIsBetween(schedule1start, schedule1end, currTimeD, location.timeZone))
        {    
            sendEvent(name: "colorTemperature", value: schedule1colorTemp, isStateChange: true, unit:  "K", type: "phsyical")
            sendEvent(name: "level", value: schedule1level, type: "phsyical", isStateChange: true)
            sendEvent(name: "scene", value: schedule1scene, type: "phsyical", isStateChange: true, descriptionText: "Phsyically triggered $schedule1scene on $device.")
            if (debug) log.info "Physically triggered ${schedule1scene} at ${schedule1level}% and ${schedule1colorTemp}k between ${schedule1start} and ${schedule1end}."
            //if (schedule1motionBool)
        }
    if( timeOfDayIsBetween(schedule2start, schedule2end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule2colorTemp, isStateChange: true, unit:  "K", type: "phsyical")
            sendEvent(name: "level", value: schedule2level, type: "phsyical", isStateChange: true)
            sendEvent(name: "scene", value: schedule2scene, type: "phsyical", isStateChange: true, descriptionText: "Phsyically triggered $schedule2scene on $device.")
            if (debug) log.info  "Physically triggered ${schedule2scene} at ${schedule2level}% and ${schedule2colorTemp}k between ${schedule2start} and ${schedule2end}."
            //if (schedule2motionBool)
        }
    if( timeOfDayIsBetween(schedule3start, schedule3end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule3colorTemp, isStateChange: true, unit:  "K", type: "phsyical")
            sendEvent(name: "level", value: schedule3level, type: "phsyical", isStateChange: true)
            sendEvent(name: "scene", value: schedule3scene, type: "phsyical", isStateChange: true, descriptionText: "Phsyically triggered $schedule3scene on $device.")
            if (debug) log.info "Physically triggered ${schedule3scene} at ${schedule3level}% and ${schedule3colorTemp}k between ${schedule3start} and ${schedule3end}."
            //if (schedule3motionBool)
        }
    if( timeOfDayIsBetween(schedule4start, schedule4end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule4colorTemp, isStateChange: true, unit:  "K", type: "phsyical")
            sendEvent(name: "level", value: schedule4level, type: "phsyical", isStateChange: true)
            sendEvent(name: "scene", value: schedule4scene, type: "phsyical",isStateChange: true, descriptionText: "Phsyically triggered $schedule4scene on $device.")
            if (debug) log.info "Physically triggered ${schedule4scene} at ${schedule4level}% and ${schedule4colorTemp}k between ${schedule4start} and ${schedule4end}."
            //if (schedule4motionBool)
        }
    if( timeOfDayIsBetween(schedule5start, schedule5end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule5colorTemp, isStateChange: true, unit:  "K", type: "phsyical")
            sendEvent(name: "level", value: schedule5level, type: "phsyical", isStateChange: true)
            sendEvent(name: "scene", value: schedule5scene, type: "phsyical", isStateChange: true, descriptionText: "Phsyically triggered $schedule5scene on $device.")
            if (debug) log.info "Physically triggered ${schedule5scene} at ${schedule5level}% and ${schedule5colorTemp}k between ${schedule5start} and ${schedule5end}."
            //if (schedule5motionBool)
        }
    if( timeOfDayIsBetween(schedule6start, schedule6end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule6colorTemp, isStateChange: true, unit:  "K", type: "phsyical")
            sendEvent(name: "level", value: schedule6level, type: "phsyical", isStateChange: true)
            sendEvent(name: "scene", value: scene6scene, type: "phsyical", isStateChange: true, descriptionText: "Phsyically triggered $schedule6scene on $device.")
            if (debug) log.info "Physically triggered ${schedule6scene} at ${schedule6level}% and ${schedule6colorTemp}k between ${schedule6start} and ${schedule6end}."
            //if (schedule6motionBool)
        }
    sendEvent(name: "switch", value: "on", isStateChange: true, type: "physical", descriptionText: "$device turned on physically.")
}
//Digital Commands
def motionOff() {
    if(device.currentValue("presence") == "not present"){
        sendEvent(name: "switch", value: "off", isStateChange: true, type: "motion", descriptionText: "$device turned off from motion timeout.")
    }else {
        motionTimeout()
        log.debug "Presence Active when Motion TImed Out, should be rescheduling"
    }
}
def off() {
	sendEvent(name: "switch", value: "off", isStateChange: true, type: "digital", descriptionText: "$device turned off digitally.")
}

def on() {
digitalTimeOfDay()
}

def setLevel(value, rate = null) {
		sendEvent(name: "level", value: value, type: "digital", descriptionText: "Level set programatically.")  
}
//Schedule for Digital Touch
void digitalTimeOfDay() {
    if (debug) log.trace "Time of Day from Digital"
    //Date currTimeD, startTimeD1, endTimeD1, startTimeD2, endTimeD2, startTimeD3, endTimeD3, startTimeD4, endTimeD4, startTimeD5, endTimeD5, transition1start
    currTimeD = new Date()
    //energize 7:30 - 10
    schedule1start = timeToday(schedule1start, location.timeZone)
    schedule1end = timeToday(schedule1end, location.timeZone)
    //concentrate 10 - 5
    schedule2start = timeToday(schedule2start, location.timeZone)
    schedule2end = timeToday(schedule2end, location.timeZone)
    //read 5 - 8
    schedule3start = timeToday(schedule3start, location.timeZone)
    schedule3end = timeToday(schedule3end, location.timeZone)
    //relax 8 - 11
    schedule4start = timeToday(schedule4start, location.timeZone)
    schedule4end = timeToday(schedule4end, location.timeZone)
    //nightlight 11 - 12
    schedule5start = timeToday(schedule5start , location.timeZone)
    schedule5end = timeToday(schedule5end, location.timeZone)
    //nightlight 12 - 7:30
    schedule6start = timeToday(schedule6start, location.timeZone)
    schedule6end = timeToday(schedule6end, location.timeZone)

    if( timeOfDayIsBetween(schedule1start, schedule1end, currTimeD, location.timeZone))
        {     
            sendEvent(name: "colorTemperature", value: schedule1colorTemp, isStateChange: true, unit:  "K", type: "digital")
            sendEvent(name: "level", value: schedule1level, type: "digital", isStateChange: true) 
            sendEvent(name: "scene", value: schedule1scene, type: "digital", isStateChange: true, descriptionText: "Digitally triggered $schedule1scene on $device.")
            if (debug) log.info  "Digitally triggered ${schedule1scene} at ${schedule1level}% and ${schedule1colorTemp}k between ${schedule1start} and ${schedule1end}."
        }
    if( timeOfDayIsBetween(schedule2start, schedule2end, currTimeD, location.timeZone))
    {
            sendEvent(name: "colorTemperature", value: schedule2colorTemp, isStateChange: true, unit:  "K", type: "digital")
            sendEvent(name: "level", value: schedule2level, type: "digital",, isStateChange: true)
            sendEvent(name: "scene", value: schedule2scene, type: "digital", isStateChange: true, descriptionText: "Digitally triggered $schedule2scene on $device.")
            if (debug) log.info  "Digitally triggered ${schedule2scene} at ${schedule2level}% and ${schedule2colorTemp}k between ${schedule2start} and ${schedule2end}."
        }
    if( timeOfDayIsBetween(schedule3start, schedule3end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule3colorTemp, isStateChange: true, unit:  "K", type: "digital")
            sendEvent(name: "level", value: schedule3level, type: "digital", isStateChange: true)
            sendEvent(name: "scene", value: schedule3scene, type: "digital", isStateChange: true, descriptionText: "Digitally triggered $schedule3scene on $device.")
            if (debug) log.info  "Digitally triggered ${schedule3scene} at ${schedule3level}% and ${schedule3colorTemp}k between ${schedule3start} and ${schedule3end}."
        }
    if( timeOfDayIsBetween(schedule4start, schedule4end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule4colorTemp, isStateChange: true, unit:  "K", type: "digital")
            sendEvent(name: "level", value: schedule4level, type: "digital", isStateChange: true)
            sendEvent(name: "scene", value: schedule4scene, type: "digital", isStateChange: true, descriptionText: "Digitally triggered $schedule4scene on $device.")
            if (debug) log.info  "Digitally triggered ${schedule4scene} at ${schedule4level}% and ${schedule4colorTemp}k between ${schedule4start} and ${schedule4end}."
        }
    if( timeOfDayIsBetween(schedule5start, schedule5end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule5colorTemp, isStateChange: true, unit:  "K", type: "digital")
            sendEvent(name: "level", value: schedule5level, type: "digital", isStateChange: true)
            sendEvent(name: "scene", value: schedule5scene, type: "digital", isStateChange: true, descriptionText: "Digitally triggered $schedule5scene on $device.")
            if (debug) log.info  "Digitally triggered ${schedule5scene} at ${schedule5level}% and ${schedule5colorTemp}k between ${schedule5start} and ${schedule5end}."
        }
    if( timeOfDayIsBetween(schedule6start, schedule6end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule6colorTemp, isStateChange: true, unit:  "K", type: "digital")
            sendEvent(name: "level", value: schedule6level, type: "digital", isStateChange: true)
            sendEvent(name: "scene", value: scene6scene, type: "digital", isStateChange: true, descriptionText: "Digitally triggered $schedule6scene on $device.")
            if (debug) log.info  "Digitally triggered ${schedule6scene} at ${schedule6level}% and ${schedule6colorTemp}k between ${schedule6start} and ${schedule6end}."
        }
    sendEvent(name: "switch", value: "on", isStateChange: true, type: "digital", descriptionText: "$device turned on programatically.")
}
//Schedule for Motion
void motionTimeOfDay() {
    if (debug) log.trace "Time of Day from Motion"
    //Date currTimeD, startTimeD1, endTimeD1, startTimeD2, endTimeD2, startTimeD3, endTimeD3, startTimeD4, endTimeD4, startTimeD5, endTimeD5, transition1start
    currTimeD = new Date()
    //energize 7:30 - 10
    schedule1start = timeToday(schedule1start, location.timeZone)
    schedule1end = timeToday(schedule1end, location.timeZone)
    //concentrate 10 - 5
    schedule2start = timeToday(schedule2start, location.timeZone)
    schedule2end = timeToday(schedule2end, location.timeZone)
    //read 5 - 8
    schedule3start = timeToday(schedule3start, location.timeZone)
    schedule3end = timeToday(schedule3end, location.timeZone)
    //relax 8 - 11
    schedule4start = timeToday(schedule4start, location.timeZone)
    schedule4end = timeToday(schedule4end, location.timeZone)
    //nightlight 11 - 12
    schedule5start = timeToday(schedule5start , location.timeZone)
    schedule5end = timeToday(schedule5end, location.timeZone)
    //nightlight 12 - 7:30
    schedule6start = timeToday(schedule6start, location.timeZone)
    schedule6end = timeToday(schedule6end, location.timeZone)
    if (overallMotion){
        if( timeOfDayIsBetween(schedule1start, schedule1end, currTimeD, location.timeZone)){
            if (schedule1motionBool){     
                sendEvent(name: "colorTemperature", value: schedule1colorTemp, isStateChange: true, unit:  "K", type: "motion")
                sendEvent(name: "level", value: schedule1level, type: "motion", isStateChange: true) 
                sendEvent(name: "scene", value: schedule1scene, type: "motion", isStateChange: true, descriptionText: "Motion triggered $motion1schedule on $device")
                if (debug) log.info  "Motion triggered ${schedule1scene} at ${schedule1level}% and ${schedule1colorTemp}k between ${schedule1start} and ${schedule1end}."
            }
        }
        if( timeOfDayIsBetween(schedule2start, schedule2end, currTimeD, location.timeZone)){
            if (schedule2motionBool){  
                sendEvent(name: "colorTemperature", value: schedule2colorTemp, isStateChange: true, unit:  "K", type: "motion", descriptionText: "$device turned on between 10:00 am & 5:00 pm. Concentrate")
                sendEvent(name: "level", value: schedule2level, type: "motion",, isStateChange: true)
                sendEvent(name: "scene", value: schedule2scene, type: "motion", isStateChange: true, descriptionText: "Motion triggered $motion2schedule on $device")
                if (debug) log.info  "Motion triggered ${schedule2scene} at ${schedule2level}% and ${schedule2colorTemp}k between ${schedule2start} and ${schedule2end}."
            }
        }
        if( timeOfDayIsBetween(schedule3start, schedule3end, currTimeD, location.timeZone)){
            if (schedule3motionBool){  
                sendEvent(name: "colorTemperature", value: schedule3colorTemp, isStateChange: true, unit:  "K", type: "motion")
                sendEvent(name: "level", value: schedule3level, type: "motion", isStateChange: true)
                sendEvent(name: "scene", value: schedule3scene, type: "motion", isStateChange: true, descriptionText: "Motion triggered $motion3schedule on $device")
                if (debug) log.info  "Motion triggered ${schedule3scene} at ${schedule3level}% and ${schedule3colorTemp}k between ${schedule3start} and ${schedule3end}."
            }
        }
        if( timeOfDayIsBetween(schedule4start, schedule4end, currTimeD, location.timeZone)){
            if (schedule4motionBool){  
                sendEvent(name: "colorTemperature", value: schedule4colorTemp, isStateChange: true, unit:  "K", type: "motion")
                sendEvent(name: "level", value: schedule4level, type: "motion", isStateChange: true)
                sendEvent(name: "scene", value: schedule4scene, type: "motion", isStateChange: true, descriptionText: "Motion triggered $motion4schedule on $device")
                if (debug) log.info  "Motion triggered ${schedule4scene} at ${schedule4level}% and ${schedule4colorTemp}k between ${schedule4start} and ${schedule4end}."
            }
        }
        if( timeOfDayIsBetween(schedule5start, schedule5end, currTimeD, location.timeZone)){
            if (schedule5motionBool){  
                sendEvent(name: "colorTemperature", value: schedule5colorTemp, isStateChange: true, unit:  "K", type: "motion")
                sendEvent(name: "level", value: schedule5level, type: "motion", isStateChange: true)
                sendEvent(name: "scene", value: schedule5scene, type: "motion", isStateChange: true, descriptionText: "Motion triggered $motion5schedule on $device")
                if (debug) log.info  "Motion triggered ${schedule5scene} at ${schedule5level}% and ${schedule5colorTemp}k between ${schedule5start} and ${schedule5end}."
            }
        }
        if( timeOfDayIsBetween(schedule6start, schedule6end, currTimeD, location.timeZone)){
            if (schedule6motionBool){  
                sendEvent(name: "colorTemperature", value: schedule6colorTemp, isStateChange: true, unit:  "K", type: "motion")
                sendEvent(name: "level", value: schedule6level, type: "motion", isStateChange: true)
                sendEvent(name: "scene", value: scene6scene, type: "motion", isStateChange: true, descriptionText: "Motion triggered $motion6schedule on $device")
                if (debug) log.info  "Motion triggered ${schedule6scene} at ${schedule6level}% and ${schedule6colorTemp}k between ${schedule6start} and ${schedule6end}."
            }
        }
        sendEvent(name: "switch", value: "on", isStateChange: true, type: "motion", descriptionText: "$device turned on by motion.")
        motionTimeout()
}
}
//Schedule for Motion Timeout
void motionTimeout() {
    timeout1=schedule1motion.toInteger()
    timeout2=schedule2motion.toInteger()
    timeout3=schedule3motion.toInteger()
    timeout4=schedule4motion.toInteger()
    timeout5=schedule5motion.toInteger()
    timeout6=schedule6motion.toInteger()

        if( timeOfDayIsBetween(schedule1start, schedule1end, currTimeD, location.timeZone))
            {         
            runIn(timeout1, motionOff, [overwrite: true])
            if (debug) log.trace  "$device scheduled to turn off in $timeout1"
            }
        if( timeOfDayIsBetween(schedule2start, schedule2end, currTimeD, location.timeZone))
            {

            }
        if( timeOfDayIsBetween(schedule3start, schedule3end, currTimeD, location.timeZone))
            {
             }
        if( timeOfDayIsBetween(schedule4start, schedule4end, currTimeD, location.timeZone))
           {  
            }
        if( timeOfDayIsBetween(schedule5start, schedule5end, currTimeD, location.timeZone))
            {
            }
        if( timeOfDayIsBetween(schedule6start, schedule6end, currTimeD, location.timeZone))
            {
            }

}

//Schuled Are Lights On Check
void areLightsOn() {
    if (debug) log.trace "Are Lights On?"
    Date currTimeD, startTimeD1, endTimeD1, startTimeD2, endTimeD2, startTimeD3, endTimeD3, startTimeD4, endTimeD4, startTimeD5, endTimeD5, transition1start
    currTimeD = new Date()
    //log.trace "current time and date = ${currTimeD}"
    //energize 7:30 - 10
    startTimeD1 = timeToday("07:30", location.timeZone)
    endTimeD1 = timeToday("10:00", location.timeZone) 
    //concentrate 10 - 5
    startTimeD2 = timeToday("10:00", location.timeZone)
    endTimeD2 = timeToday("17:00", location.timeZone) 
    //read 5 - 8
    startTimeD3 = timeToday("17:00", location.timeZone)
    endTimeD3 = timeToday("20:00", location.timeZone)
    //relax 8 - 11
    startTimeD4 = timeToday("20:00", location.timeZone)
    endTimeD4 = timeToday("23:00", location.timeZone)
    //nightlight 11 - 12
    startTimeD5 = timeToday("23:00", location.timeZone)
    endTimeD5 = timeToday("24:00", location.timeZone)
    //nightlight 12 - 7:30
    startTimeD6 = timeToday("00:00", location.timeZone)
    endTimeD6 = timeToday("07:30", location.timeZone)
    transition1start = timeToday(transition1start, location.timeZone)
    transition2start = timeToday(transition2start, location.timeZone)
    transition3start = timeToday(transition3start, location.timeZone)
    transition4start = timeToday(transition4start, location.timeZone)
    transition5start = timeToday(transition5start, location.timeZone)
    transition6start = timeToday(transition6start, location.timeZone)
    
    
    if(device.currentValue("switch") == "on"){
    if (debug) log.trace "Yeah, Lights were On"
    if( timeOfDayIsBetween(startTimeD1, endTimeD1, currTimeD, location.timeZone))
        {    
            if (transition1colorBool) sendEvent(name: "colorTemperature", value: "6410", isStateChange: true, type: "scheduled", unit:  "K", descriptionText: "Scheduled Energize for $device at 7:30 am.")  
            if (transition1levelBool) sendEvent(name: "level", value: "100", type: "scheduled", isStateChange: true)
            sendEvent(name: "scene", value: "Energize", type: "scheduled",isStateChange: true)
            if (debug) log.info  "Scheduled transition to ${transition1scene} has begun."
}

        if( timeOfDayIsBetween(startTimeD2, endTimeD2, currTimeD, location.timeZone))
        {
            if (transition2colorBool) sendEvent(name: "colorTemperature", value: "4291", isStateChange: true, type: "scheduled", unit:  "K", descriptionText: "Scheduled Concentrate for $device at 10:00 am.")
            if (transition2levelBool) sendEvent(name: "level", value: "100", type: "scheduled",isStateChange: true)
            sendEvent(name: "scene", value: "Concentrate", type: "scheduled", isStateChange: true)
            if (debug) log.info  "Scheduled transition to ${transition2scene} has begun."
        }
    if( timeOfDayIsBetween(startTimeD3, endTimeD3, currTimeD, location.timeZone))
        {
            if (transition3colorBool) sendEvent(name: "colorTemperature", value: "2890", isStateChange: true, type: "scheduled", unit:  "K", descriptionText: "Scheduled Read for $device at 5:00 pm.")
            if (transition3levelBool) sendEvent(name: "level", value: "100", type: "scheduled", isStateChange: true)
            sendEvent(name: "scene", value: "Read", type: "scheduled", isStateChange: true)
            if (debug) log.info  "Scheduled transition to ${transition3scene} has begun."
        }
    if( timeOfDayIsBetween(startTimeD4, endTimeD4, currTimeD, location.timeZone))
        {
            if (transition4colorBool) sendEvent(name: "colorTemperature", value: "2237", isStateChange: true, type: "scheduled", unit:  "K", descriptionText: "Scheduled Relax for $device at 8:00 pm.")
            if (transition4levelBool) sendEvent(name: "level", value: "60", type: "scheduled", isStateChange: true)
            sendEvent(name: "scene", value: "Relax", type: "scheduled", isStateChange: true)
            if (debug) log.info  "Scheduled transition to ${transition4scene} has begun."
        }
    if( timeOfDayIsBetween(startTimeD5, endTimeD5, currTimeD, location.timeZone))
        {
            if (transition5colorBool) sendEvent(name: "colorTemperature", value: "1700", isStateChange: true, type: "scheduled", unit:  "K", descriptionText: "$device pushed between 11:00 pm & 7:30 am. Nightlight")
            if (transition5levelBool) sendEvent(name: "level", value: "40", type: "scheduled", isStateChange: true)
            sendEvent(name: "scene", value: "Nightlight", type: "scheduled", isStateChange: true)
            if (debug) log.info  "Scheduled transition to ${transition5scene} has begun."
        }
    if( timeOfDayIsBetween(startTimeD6, endTimeD6, currTimeD, location.timeZone))
        {
            if (transition6colorBool) sendEvent(name: "colorTemperature", value: "1700", isStateChange: true, unit:  "K", descriptionText: "$device pushed between 11:00 pm & 7:30 am. Nightlight")
            if (transition6levelBool) sendEvent(name: "level", value: "20", type: "scheduled", isStateChange: true)
            sendEvent(name: "scene", value: "Nightlight", type: "scheduled", isStateChange: true)
            if (debug) log.info  "Scheduled transition to ${transition6scene} has begun."
        }
    } else
    {if (debug) log.debug "No, Lights were Not On"}
}
void colorTimeOfDay() {
    if (debug) log.trace "Color adjusting from Physical Touch"
    //Date currTimeD, startTimeD1, endTimeD1, startTimeD2, endTimeD2, startTimeD3, endTimeD3, startTimeD4, endTimeD4, startTimeD5, endTimeD5, transition1start
    currTimeD = new Date()
    //energize 7:30 - 10
    schedule1start = timeToday(schedule1start, location.timeZone)
    schedule1end = timeToday(schedule1end, location.timeZone)
    //concentrate 10 - 5
    schedule2start = timeToday(schedule2start, location.timeZone)
    schedule2end = timeToday(schedule2end, location.timeZone)
    //read 5 - 8
    schedule3start = timeToday(schedule3start, location.timeZone)
    schedule3end = timeToday(schedule3end, location.timeZone)
    //relax 8 - 11
    schedule4start = timeToday(schedule4start, location.timeZone)
    schedule4end = timeToday(schedule4end, location.timeZone)
    //nightlight 11 - 12
    schedule5start = timeToday(schedule5start , location.timeZone)
    schedule5end = timeToday(schedule5end, location.timeZone)
    //nightlight 12 - 7:30
    schedule6start = timeToday(schedule6start, location.timeZone)
    schedule6end = timeToday(schedule6end, location.timeZone)

    if( timeOfDayIsBetween(schedule1start, schedule1end, currTimeD, location.timeZone))
        {    
            sendEvent(name: "colorTemperature", value: schedule1colorTemp, isStateChange: true, unit:  "K", type: "knob")
        }
    if( timeOfDayIsBetween(schedule2start, schedule2end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule2colorTemp, isStateChange: true, unit:  "K", type: "knob")
        }
    if( timeOfDayIsBetween(schedule3start, schedule3end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule3colorTemp, isStateChange: true, unit:  "K", type: "knob")
        }
    if( timeOfDayIsBetween(schedule4start, schedule4end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule4colorTemp, isStateChange: true, unit:  "K", type: "knob")
        }
    if( timeOfDayIsBetween(schedule5start, schedule5end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule5colorTemp, isStateChange: true, unit:  "K", type: "knob")
        }
    if( timeOfDayIsBetween(schedule6start, schedule6end, currTimeD, location.timeZone))
        {
            sendEvent(name: "colorTemperature", value: schedule6colorTemp, isStateChange: true, unit:  "K", type: "knob")
        }
}

//Color Temperature
void setColorTemperature(value) {
   log.debug("Setting color temperature to $value K")
   sendEvent(name: "colorTemperature", value: value, unit: "K", isStateChange: true, displayed: "true", descriptionText: "$device color temperature adjusted.")
}
//////Scenes
def setEnergize(value) {
    sendEvent(name: "colorTemperature", value: "6410", isStateChange: true, unit:  "K", descriptionText: "$device is set to Energize")
    sendEvent(name: "level", value: "100", isStateChange: true)
    sendEvent(name: "scene", value: "Energize", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
}
def setConcentrate(value) {
    sendEvent(name: "colorTemperature", value: "4291", isStateChange: true, unit:  "K", descriptionText: "$device is set to Concentrate")
    sendEvent(name: "level", value: "100", isStateChange: true)
    sendEvent(name: "scene", value: "Concentrate", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
}
def setRead(value)    {
    sendEvent(name: "colorTemperature", value: "2890", isStateChange: true, unit:  "K", descriptionText: "$device is set to Read")
    sendEvent(name: "level", value: "100", isStateChange: true)
    sendEvent(name: "scene", value: "Read", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
}
def setRelax(value) {
    sendEvent(name: "colorTemperature", value: "2237", isStateChange: true, unit:  "K", descriptionText: "$device is set to Relax")
    sendEvent(name: "level", value: "60", isStateChange: true)
    sendEvent(name: "scene", value: "Relax", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
}
def setNightlight(value) {
    sendEvent(name: "colorTemperature", value: "1700", isStateChange: true, unit:  "K", descriptionText: "$device is set to Nightlight")
    sendEvent(name: "level", value: "20", isStateChange: true)
    sendEvent(name: "scene", value: "Nightlight", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
}
def setNight(value) {
    sendEvent(name: "colorTemperature", value: "1700", isStateChange: true, unit:  "K", descriptionText: "$device set for night")
    sendEvent(name: "level", value: "10", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
    sendEvent(name: "scene", value: "Night", isStateChange: true)
}
//def setNight2(value) {
//    sendEvent(name: "colorName", value: "Sodium", isStateChange: true, descriptionText: "$device set for night")
//    sendEvent(name: "level", value: "10", isStateChange: true)
//    sendEvent(name: "switch", value: "on", isStateChange: true)
//}
void setScene(newScene) {
 	switch (newScene){ 	
	case "Energize":
    sendEvent(name: "colorTemperature", value: "6410", isStateChange: true, unit:  "K", descriptionText: "$device set for 7 AM")
    sendEvent(name: "level", value: "100", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
    sendEvent(name: "scene", value: "Energize", isStateChange: true)
	break ;
	case "Concentrate":
    sendEvent(name: "colorTemperature", value: "4291", isStateChange: true, unit:  "K", descriptionText: "$device set for 10 AM")
    sendEvent(name: "level", value: "100", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
    sendEvent(name: "scene", value: "Concentrate", isStateChange: true)
    break ;
    case "Read":
    sendEvent(name: "colorTemperature", value: "2890", isStateChange: true, unit:  "K", descriptionText: "$device set for 5 PM")
    sendEvent(name: "level", value: "100", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
    sendEvent(name: "scene", value: "Read", isStateChange: true)
    break ;
    case "Relax":
    sendEvent(name: "colorTemperature", value: "2237", isStateChange: true, unit:  "K", descriptionText: "$device set for 8 PM")
    sendEvent(name: "level", value: "60", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
    sendEvent(name: "scene", value: "Relax", isStateChange: true)
	break ;
    case "Nightlight":
    sendEvent(name: "colorTemperature", value: "1700", isStateChange: true, unit:  "K", descriptionText: "$device set for 11 PM")
    sendEvent(name: "level", value: "20", isStateChange: true)
    sendEvent(name: "switch", value: "on", isStateChange: true)
    sendEvent(name: "scene", value: "Nightlight", isStateChange: true)
	break ;
	}
}
//Presence
def occupied(){
    sendEvent(name: "presence", value: "present", type: "physical", isStateChange: true, descriptionText: "$device button 1 was pushed")	
    setMotionInactive()
    myTimer=timer.toInteger()
    runIn(myTimer, unoccupied, [overwrite: true])
    
}
void unoccupied(){
    sendEvent(name: "presence", value: "not present", isStateChange: true, descriptionText: "$device Occupancy Timeout")
    setMotionActive() 
}

////Motion
void setMotionActive(value) {
    sendEvent(name: "motion", value: "active", isStateChange: true)
    sendEvent(name: "presence", value: "not present", type: "physical", isStateChange: true)	
    log.debug "Motion Lighting Resumed on $device"
   
}
void setMotionInactive(value) {
    sendEvent(name: "motion", value: "inactive", isStateChange: true)
    sendEvent(name: "presence", value: "present", type: "physical", isStateChange: true)
    log.debug "Motion Lighting Paused on $device"
}
void showSchedules() {
    log.info("${schedule6scene} between ${schedule6start} and ${schedule6end} at ${schedule6colorTemp}k and ${schedule6level}%.")
    log.info("${schedule5scene} between ${schedule5start} and ${schedule5end} at ${schedule5colorTemp}k and ${schedule5level}%.")
    log.info("${schedule4scene} between ${schedule4start} and ${schedule4end} at ${schedule4colorTemp}k and ${schedule4level}%.")
    log.info("${schedule3scene} between ${schedule3start} and ${schedule3end} at ${schedule3colorTemp}k and ${schedule3level}%.")
    log.info("${schedule2scene} between ${schedule2start} and ${schedule2end} at ${schedule2colorTemp}k and ${schedule2level}%.")
    log.info("${schedule1scene} between ${schedule1start} and ${schedule1end} at ${schedule1colorTemp}k and ${schedule1level}%.")
    log.warn("Scheduled Transitions will take place:")
    log.info("${schedule6scene} between ${schedule6start} and ${schedule6end} at ${schedule6colorTemp}k and ${schedule6level}%.")
    log.info("${schedule5scene} between ${schedule5start} and ${schedule5end} at ${schedule5colorTemp}k and ${schedule5level}%.")
    log.info("${schedule4scene} between ${schedule4start} and ${schedule4end} at ${schedule4colorTemp}k and ${schedule4level}%.")
    log.info("${schedule3scene} between ${schedule3start} and ${schedule3end} at ${schedule3colorTemp}k and ${schedule3level}%.")
    log.info("${schedule2scene} between ${schedule2start} and ${schedule2end} at ${schedule2colorTemp}k and ${schedule2level}%.")
    log.info("${schedule1scene} between ${schedule1start} and ${schedule1end} at ${schedule1colorTemp}k and ${schedule1level}%.")
    log.warn("Schedules for Motion On events are as follows:")
    log.info("${schedule6scene} between ${schedule6start} and ${schedule6end} at ${schedule6colorTemp}k and ${schedule6level}%.")
    log.info("${schedule5scene} between ${schedule5start} and ${schedule5end} at ${schedule5colorTemp}k and ${schedule5level}%.")
    log.info("${schedule4scene} between ${schedule4start} and ${schedule4end} at ${schedule4colorTemp}k and ${schedule4level}%.")
    log.info("${schedule3scene} between ${schedule3start} and ${schedule3end} at ${schedule3colorTemp}k and ${schedule3level}%.")
    log.info("${schedule2scene} between ${schedule2start} and ${schedule2end} at ${schedule2colorTemp}k and ${schedule2level}%.")
    log.info("${schedule1scene} between ${schedule1start} and ${schedule1end} at ${schedule1colorTemp}k and ${schedule1level}%.")
    log.warn("Schedules for Digital On events are as follows:")
    log.info("${schedule6scene} between ${schedule6start} and ${schedule6end} at ${schedule6colorTemp}k and ${schedule6level}%.")
    log.info("${schedule5scene} between ${schedule5start} and ${schedule5end} at ${schedule5colorTemp}k and ${schedule5level}%.")
    log.info("${schedule4scene} between ${schedule4start} and ${schedule4end} at ${schedule4colorTemp}k and ${schedule4level}%.")
    log.info("${schedule3scene} between ${schedule3start} and ${schedule3end} at ${schedule3colorTemp}k and ${schedule3level}%.")
    log.info("${schedule2scene} between ${schedule2start} and ${schedule2end} at ${schedule2colorTemp}k and ${schedule2level}%.")
    log.info("${schedule1scene} between ${schedule1start} and ${schedule1end} at ${schedule1colorTemp}k and ${schedule1level}%.")
    log.warn("Schedules for Physical On events are as follows:")

   
}
